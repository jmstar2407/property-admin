<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bieneraigar | Sistema de Administraci√≥n</title>
    <link rel="icon" href="./img/logo_1.png" type="image/png">

    <link rel="stylesheet" href="./css/style.css" />

    <!-- intl-tel-input CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css" />
    <!-- intl-tel-input JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>

    <!-- Font Awesome para el icono del ojo -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-auth-compat.min.js"></script>

    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Date utilities -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/index.min.js"></script>

    <style>
        .whatsapp-btn {
            color: white;
            border: none;
            border-radius: 9px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            height: 45px;
            padding: 7px 6px;
            background: #25D366;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .whatsapp-btn:hover {
            background-color: #128C7E;
        }





        /* Efecto Destello Instant√°neo */
        /*span:active,
    button:active {
        animation: flash 0.2s;
    }
    
    @keyframes flash {
        0% { background-color: rgba(255, 255, 255, 0.7); }
        100% { background-color: transparent; }
    }*/



        button,
        span,
        a {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        button:active,
        span:active,
        a:active {
            transform: scale(0.95);
        }

        button:hover,
        a:hover {
            filter: brightness(1.1);
        }






        .password-container {
            position: relative;
            margin-bottom: 14px;
            width: 100%;
        }

        .password-container input {
            padding-right: 40px;
            /* Espacio para el icono */
            width: 100%;
            box-sizing: border-box;
        }

        .toggle-password {
            position: absolute;
            right: 0px;
            top: 50%;

            cursor: pointer;
            color: #777;
            background: none;
            border: none;
            outline: none;
            font-size: 16px;
        }

        .toggle-password:hover {
            color: #333;
        }








        /* Loading Indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }


        /* Estilos para el visor de im√°genes */
#contract-image-viewer {
    transition: transform 0.25s ease;
}

#contract-image-viewer.zoomed {
    transform: scale(1.5);
    cursor: zoom-out;
}

.image-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    justify-content: center;
}
    </style>
</head>

<body>






    <!-- Contenedor de login -->
    <div id="loginContainer" style="display: none;">
        <div class="animation-wrapper">
            <div class="particle particle-1"></div>
            <div class="particle particle-2"></div>
            <div class="particle particle-3"></div>
            <div class="particle particle-4"></div>
        </div>

        <div id="loginForm">
            <h2 style="margin-block-end: 10px;">Bienvenido!</h2>
            <img src="./img/logo_1.png" style="height: 87px;margin-top: 50px;">
            <h2>Bieneraigar</h2>
            <p id="subtit" style="margin-bottom: 20px;">Sistema de Administraci√≥n</p>
            <input type="email" id="email" placeholder="Correo electr√≥nico" style="margin-bottom: 14px;">
            <div class="password-container">
                <input type="password" id="password" placeholder="Contrase√±a" style="padding: 17px 60px 17px 24px;">
                <button class="toggle-password" aria-label="Mostrar contrase√±a"
                    style="margin-top: 5px;width: 60px;background: #3258b100;margin-bottom: 0px;top: 0px;">
                    <i class="far fa-eye" style="color: #c5c7cb;"></i>
                </button>
            </div>
            <div id="errorMessage" class="error-message"></div>
            <button id="loginBtn">Iniciar sesi√≥n</button>
        </div>

        <div class="footer2">¬© - Developed by Jos√© Polanco</div>

    </div>





    <!-- Loading Overlay (oculto inicialmente) -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Cargando datos...</p>
    </div>





    <div class="Master-Box" style="display: none;">
        <!-- header fixed -->
        <div class="fixed-header">
            <div class="header">
                <div class="header-content">
                    <button id="logout-button"></button>
                    <div class="logo1"><img src="./img/logo_1.png"></div>
                    <div style="display: inline-flex;flex-direction: column;align-items: flex-start;">
                        <h1>Bieneraigar</h1>
                        <p id="subtit">Sistema de Administraci√≥n</p>
                    </div>
                </div>
            </div>

            <div class="nav-tabs">
                <div class="nav-tabs-content">
                    <button class="nav-tab active" onclick="showTab('calendar')">üìÖ Calendario</button>
                    <button class="nav-tab" onclick="showTab('properties')">üèòÔ∏è Propiedades</button>
                    <button class="nav-tab" onclick="showTab('accounting')">üí∞ Contabilidad</button>
                </div>
            </div>
        </div>
        <!-- header fixed FIN -->

        <!-- Contenido -->
        <div class="scrollable-content">
            <!-- Calendar Tab -->
            <div id="calendar-tab" class="tab-content active">



                <div class="Modal-Body">
                    <div class="view-toggle">
                        <button class="view-btn active" onclick="showView('calendar')">Calendario</button>
                        <button class="view-btn" onclick="showView('list')">Lista de Pagos</button>
                        <button class="view-btn" id="overdue-btn" onclick="showView('overdue')">
                            Atrasos <span id="overdue-count"
                                style="display:none; background:red;color:white;border-radius:50%;padding:2px 8px;margin-left:5px;">0</span>
                        </button>
                    </div>


                    <div id="calendar-view" class="calendar-view">
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <button class="calendar-nav" onclick="changeMonth(-1)">‚Üê Anterior</button>
                                <h2 class="calendar-title" id="calendar-title"></h2>
                                <button class="calendar-nav" onclick="changeMonth(1)">Siguiente ‚Üí</button>
                            </div>
                            <div class="calendar-grid" id="calendar-grid"></div>
                        </div>
                    </div>

                    <div id="list-view" class="list-view">
                        <div class="calendar-header">
                            <button class="calendar-nav" onclick="changeMonth(-1)">‚Üê Anterior</button>
                            <h2 class="calendar-title" id="list-title"></h2>
                            <button class="calendar-nav" onclick="changeMonth(1)">Siguiente ‚Üí</button>
                        </div>
                        <div id="properties-list-view"></div>
                    </div>

                    <div id="overdue-view" class="list-view">
                        <div id="overdue-list"></div>
                    </div>
                </div>

            </div>

            <!-- Properties Tab -->
            <div id="properties-tab" class="tab-content">

                <div class="Modal-Body">
                    <button class="btn add-property-btn" onclick="showAddPropertyModal()">üè† Agregar Nueva Propiedad
                        (+)</button>

                    <div class="property-status-tabs">
                        <button class="property-status-tab active"
                            onclick="filterProperties('rented')">Rentadas</button>
                        <button class="property-status-tab" onclick="filterProperties('available')">Disponibles</button>
                        <button class="property-status-tab" onclick="filterProperties('maintenance')">En
                            Mantenimiento</button>
                    </div>

                    <div id="properties-list">
                        <div class="loading">Cargando propiedades...</div>
                    </div>
                </div>
            </div>

            <!-- Accounting Tab -->
            <div id="accounting-tab" class="tab-content">

                <div class="Modal-Body">
                    <div class="month-selector">
                        <button class="calendar-nav" onclick="changeAccountingMonth(-1)">‚Üê Anterior</button>
                        <h3 id="accounting-month-title"></h3>
                        <button class="calendar-nav" onclick="changeAccountingMonth(1)">Siguiente ‚Üí</button>
                    </div>

                    <div class="accounting-summary" id="accounting-summary">
                        <div class="loading">Calculando datos...</div>
                    </div>

                    <div class="accounting-actions">
                        <button id="btn-gasto" class="btn btn-danger" onclick="showExpenseModal()">Agregar Gasto
                            (-)</button>
                        <button id="btn-ingr-extra" class="btn" onclick="showIncomeModal()">Agregar Ingreso Extra
                            (+)</button>
                    </div>

                    <div class="expenses-list" id="expenses-list"></div>
                </div>

            </div>
        </div>
        <!-- Contenido FIN -->

        <!-- footer fixed -->
        <div class="fixed-footer">
            ¬© | Developed by Jos√© Polanco
        </div>
        <!-- footer fixed FIN -->

    </div>

    <!-- Modals -->
    <div id="day-modal" class="modal">
        <div class="modal-content">

            <div class="Modal-Title">
                <h2 id="modal-day-title"></h2>
                <span class="close" onclick="closeModal('day-modal')">&times;</span>
            </div>
            <div class="Modal-Body">
                <div id="modal-properties-list"></div>
            </div>
        </div>
    </div>

    <div id="property-detail-modal" class="modal">
        <div class="modal-content">

            <div id="property-detail-content"></div>
        </div>
    </div>

    <div id="property-edit-modal" class="modal">
        <div class="modal-content">
            <div class="Modal-Title">
                <h2>‚úèÔ∏è Editar Propiedad</h2>
                <span class="close" onclick="closeModal('property-edit-modal')">&times;</span>
            </div>

            <div class="Modal-Body">
                <form id="property-edit-form">
                    <input type="hidden" id="edit-property-id">
                    <!-- Secci√≥n Propietario -->
                    <div class="section-title">üë§ Propietario:</div>
                    <div class="form-section">
                        <div class="form-group">
                            <label for="edit-owner-name">Nombre del Propietario</label>
                            <input type="text" id="edit-owner-name" required placeholder="Nombre y Apellido">
                        </div>
                        <div class="form-group">
                            <label for="edit-owner-phone">üìû Tel√©fono del Propietario</label>
                            <input type="tel" id="edit-owner-phone" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-owner-address">üìç Direcci√≥n del Propietario</label>
                            <input type="text" id="edit-owner-address">
                        </div>
                    </div>

                    <!-- Secci√≥n Propiedad -->
                    <div class="section-title">üè† Propiedad:</div>
                    <div class="form-section">
                        <div class="form-group">
                            <label for="edit-property-type">üè† Tipo de Propiedad</label>
                            <select id="edit-property-type" required>
                                <option value="casa">Casa</option>
                                <option value="apartamento">Apartamento</option>
                                <option value="local">Local Comercial</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="edit-bedrooms">üõèÔ∏è Cantidad de Habitaciones</label>
                            <input type="number" id="edit-bedrooms" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-bathrooms">üõÅ Cantidad de Ba√±os</label>
                            <input type="number" id="edit-bathrooms" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-parking-spaces">üöò Cantidad de Parqueos</label>
                            <input type="number" id="edit-parking-spaces" min="0" required>
                        </div>



                        <div class="form-group">
                            <label for="edit-property-address">üìçüè† Direcci√≥n de la Propiedad</label>
                            <input type="text" id="edit-property-address" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-rent-amount">Monto de la Renta (üí≤)</label>
                            <input type="number" id="edit-rent-amount" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-property-status">‚úÖ Estado</label>
                            <select id="edit-property-status" required onchange="toggleTenantFields()">
                                <option value="available">Disponible</option>
                                <option value="rented">Rentado</option>
                                <option value="maintenance">En Mantenimiento</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-property-notes">üóíÔ∏è Notas sobre la propiedad</label>
                            <textarea id="edit-property-notes" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Secci√≥n Inquilino (solo si est√° rentado) -->
                    <div id="tenant-section" class="form-section">
                        <div class="section-title">üë• Inquilino:</div>
                        <div class="form-group">
                            <label for="edit-tenant-name">Nombre del Inquilino</label>
                            <input type="text" id="edit-tenant-name" placeholder="Nombre y Apellido">
                        </div>
                        <div class="form-group">
                            <label for="edit-tenant-phone">üìû Tel√©fono del Inquilino</label>
                            <input type="tel" id="edit-tenant-phone">
                        </div>
                        <!-- Para el inquilino -->
                        <div class="form-group">
                            <label for="edit-tenant-id-type">ü™™ Tipo de Identificaci√≥n</label>
                            <select id="edit-tenant-id-type">
                                <option value="cedula">C√©dula</option>
                                <option value="pasaporte">Pasaporte</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-tenant-id">N√∫mero de Identificaci√≥n</label>
                            <input type="text" id="edit-tenant-id" placeholder="000-0000000-0 / 000000000">
                        </div>
                        <div class="form-group">
                            <label for="edit-contract-date">üìëFecha de Inicio de Contrato</label>
                            <input type="date" id="edit-contract-date">
                        </div>
                        <div class="form-group">
                            <label for="edit-payment-day">üìÖ D√≠a de Cobro (1-31)</label>
                            <input type="number" id="edit-payment-day" min="1" max="31">
                        </div>

                        <div class="form-group">
                            <label for="edit-contract-duration">‚è≥ Duraci√≥n del Contrato (Meses)</label>
                            <input type="number" id="edit-contract-duration" min="1">
                        </div>
                        <div class="form-group">
                            <label for="edit-tenant-notes">üóíÔ∏è Notas sobre el inquilino</label>
                            <textarea id="edit-tenant-notes" rows="2"></textarea>
                        </div>

                        <!-- Secci√≥n Garante -->
                        <div class="section-title">ü™™ Garante:</div>
                        <div class="form-group">
                            <label for="edit-guarantor-name">Nombre del Garante</label>
                            <input type="text" id="edit-guarantor-name" placeholder="Nombre y Apellido">
                        </div>
                        <div class="form-group">
                            <label for="edit-guarantor-phone">üìû Tel√©fono del Garante</label>
                            <input type="tel" id="edit-guarantor-phone">
                        </div>
                        <div class="form-group">
                            <label for="edit-guarantor-address">Direcci√≥n del Garante</label>
                            <input type="text" id="edit-guarantor-address">
                        </div>
                        <!-- Para el garante -->
                        <div class="form-group">
                            <label for="edit-guarantor-id-type">ü™™ Tipo de Identificaci√≥n</label>
                            <select id="edit-guarantor-id-type">
                                <option value="cedula">C√©dula</option>
                                <option value="pasaporte">Pasaporte</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-guarantor-id">N√∫mero de Identificaci√≥n</label>
                            <input type="text" id="edit-guarantor-id" placeholder="000-0000000-0 / 000000000">
                        </div>
                        <div class="form-group">
                            <label for="edit-guarantor-notes">üóíÔ∏è Notas sobre el garante</label>
                            <textarea id="edit-guarantor-notes" rows="2"></textarea>
                        </div>
                    </div>



<div class="form-group">
    <label for="edit-contract-image">Imagen del Contrato</label>
    <input type="file" id="edit-contract-image" accept="image/*">
</div>
<div class="contract-image-container" id="edit-current-image-container">
    <p>Imagen del contrato:</p>
    <div id="edit-current-image-wrapper">
        <img id="edit-current-image" class="contract-image" src="" style="max-width: 100%;">
    </div>
<div class="image-actions" id="edit-image-actions" style="display: none;">
    <button type="button" class="btn" onclick="viewContractImage()">üëÅÔ∏è Ver</button>
    <button type="button" class="btn" onclick="downloadContractImage()">üì• Descargar</button>
    <button type="button" class="btn btn-danger" onclick="deleteContractImage()">üóëÔ∏è Eliminar</button>
</div>
</div>

            </div>

            <div class="Modal-Footer">
                <button type="button" class="btn btn-danger"
                    onclick="deleteProperty(document.getElementById('edit-property-id').value)">üóëÔ∏è Eliminar
                    Propiedad</button>
                <button type="submit" class="btn">üíæ Guardar Cambios</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Property Modal -->
    <div id="add-property-modal" class="modal">
        <div class="modal-content">

            <div class="Modal-Title">
                <h2>üè† Agregar Nueva Propiedad (+)</h2>
                <span class="close" onclick="closeModal('add-property-modal')">&times;</span>
            </div>

            <div class="Modal-Body">
                <form id="property-form">
                    <!-- Secci√≥n Propietario -->
                    <div class="section-title">üë§ Propietario:</div>
                    <div class="form-section">
                        <div class="form-group">
                            <label for="owner-name">Nombre del Propietario</label>
                            <input type="text" id="owner-name" required placeholder="Nombre y Apellido">
                        </div>
                        <div class="form-group">
                            <label for="owner-phone">üìû Tel√©fono del Propietario</label>
                            <input type="tel" id="owner-phone" required>
                        </div>
                        <div class="form-group">
                            <label for="owner-address">üìç Direcci√≥n del Propietario</label>
                            <input type="text" id="owner-address">
                        </div>
                    </div>

                    <!-- Secci√≥n Propiedad -->
                    <div class="section-title">üè† Propiedad:</div>
                    <div class="form-section">
                        <div class="form-group">
                            <label for="property-type">üè† Tipo de Propiedad</label>
                            <select id="property-type" required>
                                <option value="casa">Casa</option>
                                <option value="apartamento">Apartamento</option>
                                <option value="local">Local Comercial</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="bedrooms">üõèÔ∏è Cantidad de Habitaciones</label>
                            <input type="number" id="bedrooms" min="0" placeholder="0" required>
                        </div>
                        <div class="form-group">
                            <label for="bathrooms">üõÅ Cantidad de Ba√±os</label>
                            <input type="number" id="bathrooms" min="0" placeholder="0" required>
                        </div>
                        <div class="form-group">
                            <label for="parking-spaces">üöò Cantidad de Parqueos</label>
                            <input type="number" id="parking-spaces" min="0" placeholder="0" required>
                        </div>


                        <div class="form-group">
                            <label for="property-address">üìçüè† Direcci√≥n de la Propiedad</label>
                            <input type="text" id="property-address" required>
                        </div>
                        <div class="form-group">
                            <label for="rent-amount">Monto de la Renta (üí≤)</label>
                            <input type="number" id="rent-amount" required>
                        </div>
                        <div class="form-group">
                            <label for="property-status">‚úÖ Estado</label>
                            <select id="property-status" required onchange="toggleTenantFields('add')">

                                <option value="available">Disponible</option>
                                <option value="rented">Rentado</option>
                                <option value="maintenance">En Mantenimiento</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="property-notes">üóíÔ∏è Notas sobre la propiedad</label>
                            <textarea id="property-notes" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Secci√≥n Inquilino (solo si est√° rentado) -->
                    <div id="tenant-section-add" class="form-section">
                        <div class="section-title">üë• Inquilino:</div>
                        <div class="form-group">
                            <label for="tenant-name">Nombre del Inquilino</label>
                            <input type="text" id="tenant-name" placeholder="Nombre y Apellido">
                        </div>
                        <div class="form-group">
                            <label for="tenant-phone">üìû Tel√©fono del Inquilino</label>
                            <input type="tel" id="tenant-phone">
                        </div>
                        <!-- Para el inquilino -->
                        <div class="form-group">
                            <label for="tenant-id-type">ü™™ Tipo de Identificaci√≥n</label>
                            <select id="tenant-id-type">
                                <option value="cedula">C√©dula</option>
                                <option value="pasaporte">Pasaporte</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tenant-id">N√∫mero de Identificaci√≥n</label>
                            <input type="text" id="tenant-id" placeholder="000-0000000-0 / 000000000">
                        </div>
                        <div class="form-group">
                            <label for="contract-date">üìë Fecha de Inicio de Contrato</label>
                            <input type="date" id="contract-date">
                        </div>
                        <div class="form-group">
                            <label for="payment-day">üìÖ D√≠a de Cobro (1-31)</label>
                            <input type="number" id="payment-day" min="1" max="31">
                        </div>
                        <div class="form-group">
                            <label for="contract-duration">‚è≥ Duraci√≥n del Contrato (Meses)</label>
                            <input type="number" id="contract-duration" min="1">
                        </div>
                        <div class="form-group">
                            <label for="tenant-notes">üóíÔ∏èNotas sobre el inquilino</label>
                            <textarea id="tenant-notes" rows="2"></textarea>
                        </div>

                        <!-- Secci√≥n Garante -->
                        <div class="section-title">ü™™ Garante:</div>
                        <div class="form-group">
                            <label for="guarantor-name">Nombre del Garante</label>
                            <input type="text" id="guarantor-name" placeholder="Nombre y Apellido">
                        </div>
                        <div class="form-group">
                            <label for="guarantor-phone">üìû Tel√©fono del Garante</label>
                            <input type="tel" id="guarantor-phone">
                        </div>
                        <div class="form-group">
                            <label for="guarantor-address">üìç Direcci√≥n del Garante</label>
                            <input type="text" id="guarantor-address">
                        </div>
                        <!-- Para el garante -->
                        <div class="form-group">
                            <label for="guarantor-id-type">ü™™ Tipo de Identificaci√≥n</label>
                            <select id="guarantor-id-type">
                                <option value="cedula">C√©dula</option>
                                <option value="pasaporte">Pasaporte</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="guarantor-id">N√∫mero de Identificaci√≥n</label>
                            <input type="text" id="guarantor-id" placeholder="000-0000000-0 / 000000000">
                        </div>
                        <div class="form-group">
                            <label for="guarantor-notes">üóíÔ∏è Notas sobre el garante</label>
                            <textarea id="guarantor-notes" rows="2"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="contract-image">Imagen del Contrato</label>
                        <input type="file" id="contract-image" accept="image/*">
                    </div>
            </div>

            <div class="Modal-Footer">
                <!-- <button type="button" class="btn btn-secondary"
                    onclick="closeModal('add-property-modal')">‚ùå Cancelar</button> -->
                <button type="submit" class="btn a√±adir">‚úÖ Agregar Propiedad</button>

                </form>
            </div>

        </div>
    </div>

    <!-- Payment History Modal -->
    <div id="payment-history-modal" class="modal">
        <div class="modal-content">

            <div class="Modal-Title">
                <h2>üìú Historial de Pagos</h2>
                <span class="close" onclick="closeModal('payment-history-modal')">&times;</span>
            </div>

            <div class="Modal-Body" style="padding: 0px;background: #202733;">
                <div id="payment-history-content"></div>
            </div>
        </div>
    </div>

    <!-- Payment Success Modal -->
    <div id="payment-success-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('payment-success-modal')">&times;</span>
            <h2>‚úÖ Pago Registrado Exitosamente</h2>
            <div id="payment-success-content"></div>
            <button class="btn" onclick="downloadInvoice(document.getElementById('payment-success-id').value)">üìÑ
                Descargar Factura</button>
            <button class="btn btn-secondary" onclick="closeModal('payment-success-modal')">Cerrar</button>
            <input type="hidden" id="payment-success-id">
        </div>
    </div>

    <!-- Income Modal -->
    <div id="income-modal" class="modal">
        <div class="modal-content">
            <div class="Modal-Title">
                <h2>Agregar Ingreso Extra (+)</h2>
                <span class="close" onclick="closeModal('income-modal')">&times;</span>
            </div>

            <div class="Modal-Body">
                <form id="income-form" style="padding: 15px;">
                    <div class="form-group">
                        <label for="income-description">üìù Descripci√≥n del Ingreso Extra (+):</label>
                        <input type="text" id="income-description" required>
                    </div>
                    <div class="form-group">
                        <label for="income-amount">Monto (üí≤):</label>
                        <input type="number" id="income-amount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="income-date">üìÖ Fecha:</label>
                        <input type="date" id="income-date" required>
                    </div>
            </div>

            <div class="Modal-Footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('income-modal')">Cancelar</button>
                <button type="submit" class="btn btn-success">üíµ Registrar Ingreso</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expense-modal" class="modal">
        <div class="modal-content">

            <div class="Modal-Title">
                <h2>Agregar Gasto (-)</h2>
                <span class="close" onclick="closeModal('expense-modal')">&times;</span>
            </div>

            <div class="Modal-Body">
                <form id="expense-form" style="padding: 15px;">
                    <div class="form-group">
                        <label for="expense-description">üìù Descripci√≥n del Gasto (-):</label>
                        <input type="text" id="expense-description" required>
                    </div>
                    <div class="form-group">
                        <label for="expense-amount">Monto (üí≤):</label>
                        <input type="number" id="expense-amount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="expense-date">üìÖ Fecha:</label>
                        <input type="date" id="expense-date" required>
                    </div>
            </div>
            <div class="Modal-Footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('expense-modal')">Cancelar</button>
                <button type="submit" class="btn btn-danger">üí∞ Registrar Gasto</button>

                </form>
            </div>
        </div>
    </div>




    <!-- Edit Payment Modal -->
    <div id="edit-payment-modal" class="modal">
        <div class="modal-content">

            <div class="Modal-Title">
                <h2>‚úèÔ∏è Editar Factura de Pago</h2>
                <span class="close" onclick="closeModal('edit-payment-modal')">&times;</span>
            </div>

            <div class="Modal-Body">
            <form id="edit-payment-form">
                <input type="hidden" id="edit-payment-id">
                <div class="form-group">
                    <label for="edit-payment-type">Tipo de Pago</label>
                    <select id="edit-payment-type" required>
                        <option value="complete">Pago Completo</option>
                        <option value="partial">Pago Parcial</option>
                        <option value="late">Pago con Mora (+ 5%)</option>
                        <option value="custom">Pago Personalizado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-payment-amount">Monto Pagado ($)</label>
                    <input type="number" id="edit-payment-amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="edit-payment-method">M√©todo de Pago</label>
                    <select id="edit-payment-method" required>
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                        <option value="Deposito">Dep√≥sito Bancario</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-payment-date">Fecha de Pago</label>
                    <input type="date" id="edit-payment-date" required>
                </div>
                <div class="form-group">
                    <label for="edit-payment-notes">Notas</label>
                    <textarea id="edit-payment-notes" rows="3"></textarea>
                </div>
                </div>

                <div class="Modal-Footer">
                <button type="button" class="btn btn-danger" onclick="deletePayment()">üóëÔ∏è Eliminar Factura</button>
           <button type="submit" class="btn">üíæ Guardar Cambios</button>
            </form>
            </div>

        </div>
    </div>




<!-- Modal para ver imagen del contrato -->
<div id="contract-image-modal" class="modal">
    <div class="modal-content">
        <div class="Modal-Title">
            <h2>Imagen del contrato</h2>
            <span class="close" onclick="closeModal('contract-image-modal')">&times;</span>
        </div>
        <div class="Modal-Body" style="text-align: center; overflow: auto;">
            <img id="contract-image-viewer" src="" style="max-width: 100%; max-height: 80vh; cursor: zoom-in;">
        </div>
    </div>
</div>


    <script>
        document.querySelector('.toggle-password').addEventListener('click', function () {
            const passwordInput = document.getElementById('password');
            const icon = this.querySelector('i');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyChPTn15TxZzKluRLzDRFwqExplejeW1p4",
            authDomain: "propiedades-admin.firebaseapp.com",
            projectId: "propiedades-admin",
            storageBucket: "propiedades-admin.appspot.com",
            messagingSenderId: "652700448283",
            appId: "1:652700448283:web:9262d6f09ee277684d6abe"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Verificar estado de autenticaci√≥n
        auth.onAuthStateChanged((user) => {
            const loginBtn = document.getElementById('loginBtn');

            if (user) {
                // Usuario autenticado
                document.getElementById('loginContainer').style.display = 'none';
                document.querySelector('.Master-Box').style.display = 'flex';

                // Mostrar loader antes de inicializar la app
                document.getElementById('loadingOverlay').style.display = 'flex';

                // Inicializar la aplicaci√≥n
                initializeApp();
            } else {
                // No autenticado - ocultar loader si est√° visible
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'flex';
                document.querySelector('.Master-Box').style.display = 'none';

                // Restablecer el bot√≥n de login
                if (loginBtn) {
                    loginBtn.textContent = 'Iniciar sesi√≥n';
                    loginBtn.disabled = false;
                }
            }
        });

        // Funci√≥n para inicializar la aplicaci√≥n despu√©s del login
        async function initializeApp() {
            try {
                // Los loaders ya se muestran en onAuthStateChanged

                // Inicializar componentes
                initializePhoneInputs();

                // Cargar datos en paralelo
                await Promise.all([
                    loadProperties(),
                    loadPayments(),
                    loadExpenses(),
                    loadIncomes()
                ]);

                // Generar vistas
                generateCalendar();
                updateAccountingView();

                // Add form listeners
                document.getElementById('property-form').addEventListener('submit', addProperty);
                document.getElementById('income-form').addEventListener('submit', addIncome);
                document.getElementById('expense-form').addEventListener('submit', addExpense);
                document.getElementById('property-edit-form').addEventListener('submit', updateProperty);

                // Inicialmente ocultar campos de inquilino si no est√° rentado
                toggleTenantFields();
                toggleTenantFields('add');

            } catch (error) {
                console.error('Error inicializando la app:', error);
                alert('Error al cargar los datos');
            } finally {
                // Ocultar el indicador de carga
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }


        // Manejar el login al presionar Enter
        document.getElementById('email').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('loginBtn').click();
            }
        });

        document.getElementById('password').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('loginBtn').click();
            }
        });

        // Manejar el login
        document.getElementById('loginBtn').addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            const loginBtn = document.getElementById('loginBtn');

            if (!email || !password) {
                errorMessage.textContent = 'Por favor ingresa correo y contrase√±a';
                return;
            }

            // Cambiar el texto del bot√≥n
            loginBtn.textContent = 'Ingresando...';
            loginBtn.disabled = true;

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    // El onAuthStateChanged manejar√° el loader
                })
                .catch((error) => {
                    // Asegurarse de ocultar el loader si falla el login
                    document.getElementById('loadingOverlay').style.display = 'none';

                    // Restablecer el bot√≥n
                    loginBtn.textContent = 'Iniciar sesi√≥n';
                    loginBtn.disabled = false;

                    let errorMsg = '';
                    switch (error.code) {
                        case 'auth/invalid-email':
                            errorMsg = 'Correo electr√≥nico inv√°lido';
                            break;
                        case 'auth/user-disabled':
                            errorMsg = 'Usuario deshabilitado';
                            break;
                        case 'auth/user-not-found':
                            errorMsg = 'Usuario no encontrado';
                            break;
                        case 'auth/wrong-password':
                            errorMsg = 'Contrase√±a incorrecta';
                            break;
                        default:
                            errorMsg = 'Credenciales incorrectas';
                            break;
                    }
                    errorMessage.textContent = errorMsg;
                });
        });


        // Global variables
        let currentDate = new Date();
        let currentAccountingDate = new Date();
        let properties = [];
        let payments = [];
        let expenses = [];
        let incomes = [];
        let currentPropertyForPayment = null;
        let currentView = 'calendar';
        let currentPropertyFilter = 'rented';



        // Inicializar inputs de tel√©fono
        function initializePhoneInputs() {
            const phoneInputs = document.querySelectorAll('input[type="tel"]');

            phoneInputs.forEach(input => {
                const iti = window.intlTelInput(input, {
                    initialCountry: "do", // Rep√∫blica Dominicana por defecto
                    separateDialCode: true,
                    utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
                });

                // Formatear mientras se escribe
                input.addEventListener('input', function () {
                    const value = this.value.replace(/\D/g, '');
                    if (value.length > 3 && value.length <= 6) {
                        this.value = `${value.slice(0, 3)}-${value.slice(3)}`;
                    } else if (value.length > 6) {
                        this.value = `${value.slice(0, 3)}-${value.slice(3, 6)}-${value.slice(6, 10)}`;
                    }
                });

                // Guardar referencia al plugin para usarlo despu√©s
                input.iti = iti;
            });
        }



        // Mostrar modal para agregar propiedad
        function showAddPropertyModal() {
            document.getElementById('property-form').reset();
            document.getElementById('contract-date').value = new Date().toISOString().split('T')[0];

            // Reinicializar los inputs de tel√©fono
            document.getElementById('owner-phone').iti.setNumber('');
            document.getElementById('tenant-phone').iti.setNumber('');
            document.getElementById('guarantor-phone').iti.setNumber('');

            openModal('add-property-modal');
        }

        // Toggle tenant fields based on property status
        function toggleTenantFields(formType = 'edit') {
            const status = formType === 'add'
                ? document.getElementById('property-status').value
                : document.getElementById('edit-property-status').value;

            const tenantSection = formType === 'add'
                ? document.getElementById('tenant-section-add')
                : document.getElementById('tenant-section');

            if (status === 'rented') {
                tenantSection.style.display = 'block';
                // Hacer requeridos los campos excepto las notas
                const requiredFields = tenantSection.querySelectorAll('input:not([type="file"]), select');
                requiredFields.forEach(field => {
                    field.required = true;
                });
            } else {
                tenantSection.style.display = 'none';
                // Quitar requerido si no es rentado
                const requiredFields = tenantSection.querySelectorAll('input, select, textarea');
                requiredFields.forEach(field => {
                    field.required = false;
                });
            }
        }

        // Filtrar propiedades por estado
        function filterProperties(status) {
            currentPropertyFilter = status;
            displayProperties();

            // Actualizar pesta√±as activas
            document.querySelectorAll('.property-status-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                0
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // Refresh data if needed
            if (tabName === 'calendar') {
                generateCalendar();
                updateListView();
            } else if (tabName === 'properties') {
                displayProperties();
            } else if (tabName === 'accounting') {
                updateAccountingView();
            }
        }

        // View toggle
        function showView(view) {
            currentView = view;

            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            document.getElementById('calendar-view').style.display = 'none';
            document.getElementById('list-view').style.display = 'none';
            document.getElementById('overdue-view').style.display = 'none';

            if (view === 'calendar') {
                document.getElementById('calendar-view').style.display = 'block';
            } else if (view === 'list') {
                document.getElementById('list-view').style.display = 'block';
                updateListView();
            } else if (view === 'overdue') {
                document.getElementById('overdue-view').style.display = 'block';
                updateOverdueView();
            }
        }


        // Load data from Firebase
        async function loadProperties() {
            try {
                const snapshot = await db.collection('properties').get();
                properties = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    createdAt: doc.data().createdAt?.toDate(),
                    contractStart: doc.data().contractStart?.toDate()
                }));

                currentPropertyFilter = 'rented';
                displayProperties();
                generateCalendar();
                updateListView();
                updateOverdueView();
            } catch (error) {
                console.error('Error loading properties:', error);
                // Use mock data for demo
                properties = [
                    {
                        id: '1',
                        ownerName: 'Carlos L√≥pez',
                        ownerPhone: '555-1234',
                        ownerAddress: 'Calle Principal 123',
                        propertyType: 'casa',
                        address: 'Avenida Central 456',
                        rentAmount: 15000,
                        status: 'rented',
                        notes: 'Propiedad en buen estado',
                        tenantName: 'Juan P√©rez',
                        tenantPhone: '555-5678',
                        tenantId: '123456789',
                        paymentDay: 15,
                        contractStart: new Date(),
                        contractDuration: 12,
                        tenantNotes: 'Inquilino responsable',
                        guarantorName: 'Mar√≠a Garc√≠a',
                        guarantorPhone: '555-9012',
                        guarantorAddress: 'Calle Secundaria 789',
                        guarantorId: '987654321',
                        guarantorNotes: 'Garante confiable',
                        imageContrato: ''
                    }
                ];
                displayProperties();
                generateCalendar();
                updateListView();
            }
        }

        async function loadPayments() {
            try {
                const snapshot = await db.collection('payments').get();
                payments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    paymentDate: doc.data().paymentDate?.toDate(),
                    dueDate: doc.data().dueDate?.toDate(),
                    mesPagado: doc.data().mesPagado || new Date(doc.data().dueDate?.toDate().getFullYear(), doc.data().dueDate?.toDate().getMonth() - 1, 1).toLocaleDateString('es-ES', { month: 'long' }).replace(/^\w/, c => c.toUpperCase())
                }));
                generateCalendar();
                updateListView();
                updateOverdueView();
            } catch (error) {
                console.error('Error loading payments:', error);
                payments = [];
            }
        }

        async function loadExpenses() {
            try {
                const snapshot = await db.collection('expenses').get();
                expenses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().date?.toDate()
                }));
                updateAccountingView();
            } catch (error) {
                console.error('Error loading expenses:', error);
                expenses = [];
            }
        }

        async function loadIncomes() {
            try {
                const snapshot = await db.collection('incomes').get();
                incomes = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().date?.toDate()
                }));
                updateAccountingView();
            } catch (error) {
                console.error('Error loading incomes:', error);
                incomes = [];
            }
        }

      // Add new property
async function addProperty(e) {
    e.preventDefault();

    const contractImage = document.getElementById('contract-image').files[0];
    let imageBase64 = '';

    if (contractImage) {
        try {
            imageBase64 = await convertImageToBase64(contractImage);
        } catch (error) {
            alert(error.message || 'Error al procesar la imagen');
            return;
        }
    }

    // Obtener n√∫meros de tel√©fono formateados
    const ownerPhone = document.getElementById('owner-phone').iti.getNumber();
    const tenantPhone = document.getElementById('tenant-phone')?.iti?.getNumber() || '';
    const guarantorPhone = document.getElementById('guarantor-phone')?.iti?.getNumber() || '';

    const newProperty = {
        ownerName: document.getElementById('owner-name').value,
        ownerPhone: ownerPhone,
        ownerAddress: document.getElementById('owner-address').value,
        propertyType: document.getElementById('property-type').value,
        bedrooms: parseInt(document.getElementById('bedrooms').value),
        bathrooms: parseInt(document.getElementById('bathrooms').value),
        parkingSpaces: parseInt(document.getElementById('parking-spaces').value),
        address: document.getElementById('property-address').value,
        rentAmount: parseFloat(document.getElementById('rent-amount').value),
        status: document.getElementById('property-status').value,
        notes: document.getElementById('property-notes').value,
        imageContrato: imageBase64,
        createdAt: new Date()
    };

    // Solo agregar datos de inquilino si est√° rentado
    if (newProperty.status === 'rented') {
        newProperty.tenantName = document.getElementById('tenant-name').value;
        newProperty.tenantPhone = tenantPhone;
        newProperty.tenantIdType = document.getElementById('tenant-id-type').value;
        newProperty.tenantId = document.getElementById('tenant-id').value;
        newProperty.paymentDay = parseInt(document.getElementById('payment-day').value);
        newProperty.contractStart = new Date(document.getElementById('contract-date').value);
        newProperty.contractDuration = parseInt(document.getElementById('contract-duration').value);
        newProperty.tenantNotes = document.getElementById('tenant-notes').value;
        newProperty.guarantorName = document.getElementById('guarantor-name').value;
        newProperty.guarantorPhone = guarantorPhone;
        newProperty.guarantorAddress = document.getElementById('guarantor-address').value;
        newProperty.guarantorIdType = document.getElementById('guarantor-id-type').value;
        newProperty.guarantorId = document.getElementById('guarantor-id').value;
        newProperty.guarantorNotes = document.getElementById('guarantor-notes').value;
    }

    try {
        const docRef = await db.collection('properties').add(newProperty);
        newProperty.id = docRef.id;
        properties.push(newProperty);

        document.getElementById('property-form').reset();
        closeModal('add-property-modal');
        displayProperties();
        generateCalendar();
        updateListView();

        alert('‚úÖ Propiedad agregada exitosamente');
    } catch (error) {
        console.error('Error adding property:', error);
        // Demo mode - add to local array
        newProperty.id = Date.now().toString();
        properties.push(newProperty);
        document.getElementById('property-form').reset();
        closeModal('add-property-modal');
        displayProperties();
        generateCalendar();
        updateListView();
        alert('‚úÖ Propiedad agregada (modo demo)');
    }
}





// Funci√≥n para optimizar y comprimir im√°genes
async function optimizeImage(file) {
    return new Promise((resolve, reject) => {
        // Verificar tama√±o m√°ximo (4MB)
        if (file.size > 4 * 1024 * 1024) {
            reject(new Error('La imagen es demasiado grande (m√°ximo 4MB)'));
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                // Crear canvas para redimensionar
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Tama√±o m√°ximo deseado (ancho o alto)
                const MAX_WIDTH = 1920;
                const MAX_HEIGHT = 1920;
                
                let width = img.width;
                let height = img.height;
                
                // Redimensionar si es necesario
                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Dibujar imagen redimensionada
                ctx.drawImage(img, 0, 0, width, height);
                
                // Comprimir a JPEG con calidad del 70%
                canvas.toBlob((blob) => {
                    if (blob.size > 1920 * 1920) { // Si a√∫n es mayor a 1MB
                        // Intentar con m√°s compresi√≥n
                        canvas.toBlob((smallerBlob) => {
                            resolve(smallerBlob);
                        }, 'image/jpeg', 0.7); // Calidad del 70%
                    } else {
                        resolve(blob);
                    }
                }, 'image/jpeg', 0.7); // Calidad inicial del 70%
            };
            
            img.onerror = function() {
                reject(new Error('Error al cargar la imagen'));
            };
            
            img.src = event.target.result;
        };
        
        reader.onerror = function() {
            reject(new Error('Error al leer el archivo'));
        };
        
        reader.readAsDataURL(file);
    });
}



// Convert image to Base64 con optimizaci√≥n
function convertImageToBase64(file) {
    return new Promise(async (resolve, reject) => {
        try {
            // Optimizar la imagen primero
            const optimizedBlob = await optimizeImage(file);
            
            const reader = new FileReader();
            reader.readAsDataURL(optimizedBlob);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        } catch (error) {
            console.error('Error al optimizar la imagen:', error);
            reject(error);
        }
    });
}




        // Display properties list with filtering
        function displayProperties() {
            const container = document.getElementById('properties-list');

            // Filtrar propiedades seg√∫n el estado seleccionado
            let filteredProperties = properties.filter(p => p.status === currentPropertyFilter);

            // Ordenar por direcci√≥n
            filteredProperties.sort((a, b) => a.address.localeCompare(b.address));

            if (filteredProperties.length === 0) {
                container.innerHTML = '<div class="no-data">üìã No hay propiedades registradas</div>';
                return;
            }


            const html = filteredProperties.map(property => {
                // Calcular d√≠as restantes del contrato si est√° rentado
                let contractInfo = '';
                if (property.status === 'rented' && property.contractStart && property.contractDuration) {
                    const endDate = new Date(property.contractStart);
                    endDate.setMonth(endDate.getMonth() + property.contractDuration);
                    const today = new Date();
                    const diffTime = endDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays > 0) {
                        contractInfo = `<p class="contract-days remaining">‚è≥ ${diffDays} d√≠as restantes de contrato</p>`;
                    } else {
                        contractInfo = `<p class="contract-days expired">‚ö†Ô∏è Contrato vencido el ${endDate.toLocaleDateString('es-ES')}</p>`;
                    }
                }

                // Determinar clase de estado
                let statusClass = '';
                let statusText = '';
                switch (property.status) {
                    case 'rented':
                        statusClass = 'rented';
                        statusText = 'Rentado';
                        break;
                    case 'available':
                        statusClass = 'available';
                        statusText = 'Disponible';
                        break;
                    case 'maintenance':
                        statusClass = 'maintenance';
                        statusText = 'En Mantenimiento';
                        break;
                }

                return `
    <div class="property-card">
        <div class="property-header">
            <div class="property-title">üìç Direcci√≥n: ${property.address}</div>
            <span class="property-status-badge ${statusClass}">${statusText}</span>
        </div>
        <div class="property-details" style="padding: 5px;">
            <p><strong>üè† Tipo:</strong> ${property.propertyType}</p>
            <p><strong>üõèÔ∏è Habit.:</strong> ${property.bedrooms || 0}<strong> | üöø Ba√±os:</strong> ${property.bathrooms || 0} | <strong>üöó Garaj.:</strong> ${property.parkingSpaces || 0}</p>
            <p><strong>üí∞ Renta (Mes):</strong> <span style="color: #4a82cb;font-weight: bold;">RD$ ${property.rentAmount.toLocaleString()}</span></p>
            <p><strong>üë§ Propietario:</strong> ${property.ownerName}</p>
            ${property.status === 'rented' ? `<p><strong>üë• Inquilino:</strong> ${property.tenantName}</p>` : ''}
            ${property.status === 'rented' ? `<p><strong>üìÖ D√≠a de Cobro:</strong> <span style="color: #4a82cb;font-weight: bold;">${property.paymentDay}</span></p>` : ''}
            ${contractInfo}
        </div>
        <div class="property-actions">
            <button class="btn" onclick="showPropertyDetailModal('${property.id}')">‚úèÔ∏è Editar</button>
            <button class="btn btn-secondary" onclick="openModal('payment-history-modal'); showPaymentHistory('${property.id}')" style="background: linear-gradient(135deg, #46a9ef 0%, #1a5dc1 100%);">üìú Historial</button>
        </div>
    </div>
`;
            }).join('');

            container.innerHTML = html;
        }

        // Show payment history for a property
        function showPaymentHistory(propertyId) {
            const property = properties.find(p => p.id === propertyId);
            if (!property) return;

            const propertyPayments = payments.filter(p => p.propertyId === property.id)
                .sort((a, b) => b.paymentDate - a.paymentDate);

            const modal = document.getElementById('payment-history-modal');
            const content = document.getElementById('payment-history-content');

            let html = `
            <div style="border-bottom: 1px solid #383f4f; padding: 10px 15px;color: white;font-size: 14px;background: #252835;">
        <h3>üè†üìç ${property.address}</h3>
        <p><strong>üë§ Propietario:</strong> ${property.ownerName}</p>
        </div>
    `;

            if (propertyPayments.length > 0) {
                html += `
            <div class="payment-history">
                ${propertyPayments.map(p => `
<div class="payment-item">
    <div>
        <strong>${p.tenantName || 'N/A'}</strong> | <strong>Renta:</strong> RD$${p.rentAmount.toLocaleString()}
        <p><strong>Recibido:</strong>  RD$${p.amount} / ${p.paymentMethod}</p>
        <p><strong>Mes pagado: </strong>${p.mesPagado} de ${p.year}</p>
    </div>
    <div class="btn-factura-content">
        <button class="btn" onclick="showEditPaymentModal('${p.id}')" style="background: #145b4e;">‚úèÔ∏è</button>
        <button class="btn btn-danger" onclick="deletePaymentFromHistory('${p.id}', '${propertyId}')" style="display: none;">üóëÔ∏è</button>
        <button class="btn" onclick="downloadInvoice('${p.id}')" style="background: #2266bd;">üìÑ</button>
    </div>
</div>
                `).join('')}
            </div>
        `;
            } else {
                html += '<p style="text-align: center;margin: 50px 5px;color: #a0aec0;">üìã No hay pagos registrados para esta propiedad.</p>';
            }

            content.innerHTML = html;
            modal.style.display = 'block';
        }

        async function deletePaymentFromHistory(paymentId, propertyId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta factura?')) {
                return;
            }

            try {
                await db.collection('payments').doc(paymentId).delete();
                payments = payments.filter(p => p.id !== paymentId);

                // Actualizar el historial sin cerrar el modal
                showPaymentHistory(propertyId);

                // Actualizar otras vistas
                updateListView();
                updateOverdueView();
                generateCalendar();
                updateAccountingView();

                alert('‚úÖ Factura eliminada exitosamente');
            } catch (error) {
                console.error('Error deleting payment:', error);
                // Demo mode
                payments = payments.filter(p => p.id !== paymentId);

                // Actualizar el historial en modo demo
                showPaymentHistory(propertyId);

                updateListView();
                updateOverdueView();
                generateCalendar();
                updateAccountingView();

                alert('‚úÖ Factura eliminada (modo demo)');
            }
        }

// Show property detail modal for editing
function showPropertyDetailModal(propertyId) {
    const property = properties.find(p => p.id === propertyId);
    if (!property) return;

    // Mostrar mensaje sobre el tama√±o de la imagen
    const imageInput = document.getElementById('edit-contract-image');
    imageInput.onchange = function() {
        if (this.files[0].size > 4 * 1024 * 1024) {
            alert('La imagen es demasiado grande (m√°ximo 4MB). Se comprimir√° autom√°ticamente.');
        }
    };

            // Llenar formulario con datos de la propiedad
            document.getElementById('edit-property-id').value = property.id;

            // Datos del propietario
            document.getElementById('edit-owner-name').value = property.ownerName || '';
            document.getElementById('edit-owner-phone').value = property.ownerPhone || '';
            if (property.ownerPhone) {
                document.getElementById('edit-owner-phone').iti.setNumber(property.ownerPhone);
            }
            document.getElementById('edit-owner-address').value = property.ownerAddress || '';

            // Datos de la propiedad
            document.getElementById('edit-property-type').value = property.propertyType || 'casa';
            document.getElementById('edit-bedrooms').value = property.bedrooms || 0;
            document.getElementById('edit-bathrooms').value = property.bathrooms || 0;
            document.getElementById('edit-parking-spaces').value = property.parkingSpaces || 0;
            document.getElementById('edit-property-address').value = property.address || '';
            document.getElementById('edit-rent-amount').value = property.rentAmount || '';
            document.getElementById('edit-property-status').value = property.status || 'available';
            document.getElementById('edit-property-notes').value = property.notes || '';

            // Datos del inquilino (si est√° rentado)
            document.getElementById('edit-tenant-name').value = property.tenantName || '';
            document.getElementById('edit-tenant-phone').value = property.tenantPhone || '';
            if (property.tenantPhone) {
                document.getElementById('edit-tenant-phone').iti.setNumber(property.tenantPhone);
            }
            document.getElementById('edit-tenant-id-type').value = property.tenantIdType || 'cedula';
            document.getElementById('edit-tenant-id').value = property.tenantId || '';
            document.getElementById('edit-payment-day').value = property.paymentDay || '';
            document.getElementById('edit-contract-duration').value = property.contractDuration || '';
            document.getElementById('edit-tenant-notes').value = property.tenantNotes || '';

            // Datos del garante
            document.getElementById('edit-guarantor-name').value = property.guarantorName || '';
            document.getElementById('edit-guarantor-phone').value = property.guarantorPhone || '';
            if (property.guarantorPhone) {
                document.getElementById('edit-guarantor-phone').iti.setNumber(property.guarantorPhone);
            }
            document.getElementById('edit-guarantor-address').value = property.guarantorAddress || '';
            document.getElementById('edit-guarantor-id-type').value = property.guarantorIdType || 'cedula';
            document.getElementById('edit-guarantor-id').value = property.guarantorId || '';
            document.getElementById('edit-guarantor-notes').value = property.guarantorNotes || '';

            // Fecha de contrato
            if (property.contractStart) {
                const formattedDate = property.contractStart.toISOString().split('T')[0];
                document.getElementById('edit-contract-date').value = formattedDate;
            } else {
                document.getElementById('edit-contract-date').value = '';
            }

            // Mostrar imagen actual si existe
updateImageDisplay();

            // Asegurarse de que los campos de inquilino se muestren correctamente
            toggleTenantFields();

            openModal('property-edit-modal');
        }

      // Update property
async function updateProperty(e) {
    e.preventDefault();

    const propertyId = document.getElementById('edit-property-id').value;
    const propertyIndex = properties.findIndex(p => p.id === propertyId);
    if (propertyIndex === -1) return;

    const contractImage = document.getElementById('edit-contract-image').files[0];
    let imageBase64 = properties[propertyIndex].imageContrato;

    if (contractImage) {
        try {
            imageBase64 = await convertImageToBase64(contractImage);
        } catch (error) {
            alert(error.message || 'Error al procesar la imagen');
            return;
        }
    }

    // Obtener n√∫meros de tel√©fono formateados
    const ownerPhone = document.getElementById('edit-owner-phone').iti.getNumber();
    const tenantPhone = document.getElementById('edit-tenant-phone')?.iti?.getNumber() || '';
    const guarantorPhone = document.getElementById('edit-guarantor-phone')?.iti?.getNumber() || '';

    const updatedProperty = {
        ownerName: document.getElementById('edit-owner-name').value,
        ownerPhone: ownerPhone,
        ownerAddress: document.getElementById('edit-owner-address').value,
        propertyType: document.getElementById('edit-property-type').value,
        bedrooms: parseInt(document.getElementById('edit-bedrooms').value),
        bathrooms: parseInt(document.getElementById('edit-bathrooms').value),
        parkingSpaces: parseInt(document.getElementById('edit-parking-spaces').value),
        address: document.getElementById('edit-property-address').value,
        rentAmount: parseFloat(document.getElementById('edit-rent-amount').value),
        status: document.getElementById('edit-property-status').value,
        notes: document.getElementById('edit-property-notes').value,
        imageContrato: imageBase64
    };

    // Solo actualizar datos de inquilino si est√° rentado
    if (updatedProperty.status === 'rented') {
        updatedProperty.tenantName = document.getElementById('edit-tenant-name').value;
        updatedProperty.tenantPhone = tenantPhone;
        updatedProperty.tenantId = document.getElementById('edit-tenant-id').value;
        updatedProperty.paymentDay = parseInt(document.getElementById('edit-payment-day').value);
        updatedProperty.contractStart = new Date(document.getElementById('edit-contract-date').value);
        updatedProperty.contractDuration = parseInt(document.getElementById('edit-contract-duration').value);
        updatedProperty.tenantNotes = document.getElementById('edit-tenant-notes').value;
        updatedProperty.guarantorName = document.getElementById('edit-guarantor-name').value;
        updatedProperty.guarantorPhone = guarantorPhone;
        updatedProperty.guarantorAddress = document.getElementById('edit-guarantor-address').value;
        updatedProperty.guarantorId = document.getElementById('edit-guarantor-id').value;
        updatedProperty.guarantorNotes = document.getElementById('edit-guarantor-notes').value;
    } else {
        // Limpiar datos de inquilino si ya no est√° rentado
        updatedProperty.tenantName = '';
        updatedProperty.tenantPhone = '';
        updatedProperty.tenantId = '';
        updatedProperty.paymentDay = null;
        updatedProperty.contractStart = null;
        updatedProperty.contractDuration = null;
        updatedProperty.tenantNotes = '';
        updatedProperty.guarantorName = '';
        updatedProperty.guarantorPhone = '';
        updatedProperty.guarantorAddress = '';
        updatedProperty.guarantorId = '';
        updatedProperty.guarantorNotes = '';
    }

    try {
        await db.collection('properties').doc(propertyId).update(updatedProperty);
        properties[propertyIndex] = { ...properties[propertyIndex], ...updatedProperty };

        closeModal('property-edit-modal');
        displayProperties();
        generateCalendar();
        updateListView();

        alert('‚úÖ Propiedad actualizada exitosamente');
    } catch (error) {
        console.error('Error updating property:', error);
        // Demo mode
        properties[propertyIndex] = { ...properties[propertyIndex], ...updatedProperty };
        closeModal('property-edit-modal');
        displayProperties();
        generateCalendar();
        updateListView();
        alert('‚úÖ Propiedad actualizada (modo demo)');
    }
}

        // Delete property
        async function deleteProperty(propertyId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta propiedad?')) {
                return;
            }

            try {
                await db.collection('properties').doc(propertyId).delete();
                properties = properties.filter(p => p.id !== propertyId);
                closeModal('property-edit-modal');
                displayProperties();
                generateCalendar();
                updateListView();
                alert('‚úÖ Propiedad eliminada');
            } catch (error) {
                console.error('Error deleting property:', error);
                // Demo mode
                properties = properties.filter(p => p.id !== propertyId);
                closeModal('property-edit-modal');
                displayProperties();
                generateCalendar();
                updateListView();
                alert('‚úÖ Propiedad eliminada (modo demo)');
            }
        }

        // Calendar functions
        function generateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            const monthYear = currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            document.getElementById('calendar-title').textContent =
                monthYear.charAt(0).toUpperCase() + monthYear.slice(1);

            // Esta es la l√≠nea modificada:
            const listMonthYear = currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            document.getElementById('list-title').textContent =
                listMonthYear.charAt(0).toUpperCase() + listMonthYear.slice(1);

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            // Day headers
            const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            // Calendar days
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                date.setHours(0, 0, 0, 0);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = date.getDate();

                if (date.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }

                if (date.getTime() === today.getTime()) {
                    dayElement.classList.add('today');
                }

                const dayProperties = getPropertiesForDay(date);
                if (dayProperties.length > 0) {
                    dayElement.classList.add('has-properties');

                    // Verificar si TODAS las propiedades est√°n pagadas
                    const allPaid = dayProperties.every(({ property, date: dueDate }) =>
                        isPropertyPaid(property, dueDate)
                    );

                    // Determinar el estado basado en todas las propiedades
                    let statusClass = '';
                    if (allPaid) {
                        statusClass = 'paid';
                    } else {
                        // Si no todas est√°n pagadas, verificar el peor estado
                        let worstStatus = '';
                        dayProperties.forEach(({ property, date: dueDate }) => {
                            if (isPropertyPaid(property, dueDate)) return;

                            const daysOverdue = calculateOverdueDays(property, dueDate);
                            if (daysOverdue > 5) {
                                worstStatus = 'overdue';
                            } else if (daysOverdue > 0 && worstStatus !== 'overdue') {
                                worstStatus = 'grace-period';
                            } else if (worstStatus === '') {
                                worstStatus = 'pending';
                            }
                        });
                        statusClass = worstStatus || 'pending';
                    }

                    dayElement.classList.add(statusClass);

                    const countElement = document.createElement('div');
                    countElement.className = 'property-count';
                    countElement.textContent = dayProperties.length;
                    dayElement.appendChild(countElement);
                }

                dayElement.addEventListener('click', () => showDayModal(date, dayProperties));
                grid.appendChild(dayElement);
            }

            updateOverdueView();
        }


        // Update list view
        function updateListView() {
            const container = document.getElementById('properties-list-view');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            const paymentDays = {};

            properties.forEach(property => {
                if (property.status !== 'rented' || !property.contractStart) return;

                const contractDate = new Date(property.contractStart);
                contractDate.setHours(0, 0, 0, 0);
                const dueDate = new Date(year, month, property.paymentDay);
                dueDate.setHours(0, 0, 0, 0);

                // Solo excluir si es exactamente el mismo d√≠a del inicio del contrato
                if (dueDate.getTime() === contractDate.getTime()) {
                    return;
                }

                // Incluir si la fecha de pago es posterior o igual al inicio del contrato
                if (dueDate >= contractDate) {
                    const isPaid = isPropertyPaid(property, dueDate);
                    const daysOverdue = calculateOverdueDays(property, dueDate);

                    let statusClass = '';
                    let statusText = '';

                    if (isPaid) {
                        statusClass = 'paid';
                        statusText = 'Pagado';
                    } else if (daysOverdue > 5) {
                        statusClass = 'overdue';
                        statusText = `${daysOverdue} d√≠as de atraso`;
                    } else if (daysOverdue > 0) {
                        statusClass = 'grace-period';
                        statusText = `${daysOverdue} d√≠as de gracia`;
                    } else {
                        statusClass = 'pending';
                        statusText = 'Pendiente';
                    }

                    if (!paymentDays[dueDate.getDate()]) {
                        paymentDays[dueDate.getDate()] = [];
                    }

                    paymentDays[dueDate.getDate()].push({
                        property,
                        dueDate,
                        statusClass,
                        statusText,
                        isFirstMonth: dueDate.getMonth() === contractDate.getMonth() &&
                            dueDate.getFullYear() === contractDate.getFullYear()
                    });
                }
            });

            // Sort days
            const sortedDays = Object.keys(paymentDays).sort((a, b) => a - b);

            if (sortedDays.length === 0) {
                container.innerHTML = '<div class="no-data">üìã No hay pagos pendientes este mes</div>';
                return;
            }

            // Generate HTML
            let html = '';

            sortedDays.forEach(day => {
                const dayInt = parseInt(day);
                const dueDate = new Date(year, month, dayInt);
                const paidMonth = new Date(dueDate);
                paidMonth.setMonth(paidMonth.getMonth() - 1);

                html += `
            <h3 id="list-font-mes">üìÖ ${dueDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' })} (Pago para ${paidMonth.toLocaleDateString('es-ES', { month: 'long' })})</h3>
        `;

                paymentDays[day].forEach(item => {
                    html += `
                <div class="property-list-item ${item.statusClass}" onclick="showPropertyDetail('${item.property.id}', '${item.dueDate.toISOString()}')">
                    <div id="titulo-dias">
                        <strong>${item.property.tenantName}</strong>
                        <p>üìç ${item.property.address}</p>
                    </div>
                    <div id="monto-dias">
                        <span>$${item.property.rentAmount.toLocaleString()}</span>
                        <span class="status-badge ${item.statusClass}">${item.statusText}</span>
                    </div>
                </div>
            `;
                });
            });

            container.innerHTML = html;
        }


        function updateOverdueView() {
            const container = document.getElementById('overdue-list');
            let overdueItems = [];

            properties.forEach(property => {
                if (property.status !== 'rented' || !property.contractStart || !property.paymentDay) return;

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const contractStart = new Date(property.contractStart);
                contractStart.setHours(0, 0, 0, 0);

                // 1. Verificar pagos del mes actual
                const currentMonthDueDate = new Date(today.getFullYear(), today.getMonth(), property.paymentDay);
                currentMonthDueDate.setHours(0, 0, 0, 0);

                if (currentMonthDueDate < today && !isPropertyPaid(property, currentMonthDueDate)) {
                    const daysOverdue = Math.floor((today - currentMonthDueDate) / (1000 * 60 * 60 * 24));
                    overdueItems.push({
                        property,
                        dueDate: currentMonthDueDate,
                        daysOverdue,
                        isCurrentMonth: true
                    });
                }

                // 2. Verificar meses anteriores no pagados
                let checkDate = new Date(contractStart);
                while (checkDate < today) {
                    const dueDate = new Date(checkDate.getFullYear(), checkDate.getMonth(), property.paymentDay);
                    dueDate.setHours(0, 0, 0, 0);

                    // Solo agregar si es una fecha v√°lida y no est√° pagada
                    if (dueDate >= contractStart && dueDate < today && !isPropertyPaid(property, dueDate)) {
                        const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));

                        // Evitar duplicados del mes actual que ya verificamos
                        if (!(dueDate.getMonth() === currentMonthDueDate.getMonth() &&
                            dueDate.getFullYear() === currentMonthDueDate.getFullYear())) {
                            overdueItems.push({
                                property,
                                dueDate,
                                daysOverdue,
                                isCurrentMonth: false
                            });
                        }
                    }

                    // Avanzar al siguiente mes
                    checkDate.setMonth(checkDate.getMonth() + 1);
                }
            });

            // Actualizar contador
            const overdueCountElement = document.getElementById('overdue-count');
            overdueCountElement.textContent = overdueItems.length;
            overdueCountElement.style.display = overdueItems.length > 0 ? 'inline-block' : 'none';

            if (overdueItems.length === 0) {
                container.innerHTML = '<div class="no-data">üéâ No hay atrasos actualmente.</div>';
                return;
            }

            // Ordenar por d√≠as de atraso (mayor primero)
            overdueItems.sort((a, b) => b.daysOverdue - a.daysOverdue);

            // Generar HTML
            let html = overdueItems.map(item => {
                const monthName = item.dueDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                return `
        <div class="property-list-item overdue" 
             onclick="showPropertyDetail('${item.property.id}', '${item.dueDate.toISOString()}')">
            <div id="titulo-dias">
                <strong>üë• ${item.property.tenantName}</strong>
                <p>üìç ${item.property.address}</p>
                Mes de <strong style="    color: red;">${monthName}</strong> pendiente de pago.
            </div>
            <div id="monto-dias-2">
                <span>RD$${item.property.rentAmount.toLocaleString()}</span>
                <span class="status-badge overdue">${item.daysOverdue} D√≠as de Atraso</span>
            </div>
        </div>
        `;
            }).join('');

            container.innerHTML = html;
        }




        function getPropertiesForDay(date) {
            return properties.filter(property => {
                if (property.status !== 'rented' || !property.contractStart) return false;

                const currentDate = new Date(date);
                currentDate.setHours(0, 0, 0, 0);

                const contractDate = new Date(property.contractStart);
                contractDate.setHours(0, 0, 0, 0);

                // Verificar que sea el d√≠a de pago y que la fecha sea posterior o igual al inicio del contrato
                if (property.paymentDay === currentDate.getDate() && currentDate >= contractDate) {
                    // Solo excluir si es exactamente el mismo d√≠a del inicio del contrato
                    if (currentDate.getTime() === contractDate.getTime()) {
                        return false;
                    }
                    return true;
                }
                return false;
            }).map(property => ({ property, date: new Date(date) }));
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar();
            updateListView();
        }

        // Modal functions
        function showDayModal(date, dayProperties) {
            if (dayProperties.length === 0) return;

            const modal = document.getElementById('day-modal');
            const title = document.getElementById('modal-day-title');
            const list = document.getElementById('modal-properties-list');

            title.textContent = `üìÖ ${date.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            })}`;

            const html = dayProperties.map(({ property, date: dueDate }) => {
                const isPaid = isPropertyPaid(property, dueDate);
                const daysOverdue = calculateOverdueDays(property, dueDate);

                let statusClass = '';
                let statusText = '';

                if (isPaid) {
                    statusClass = 'paid';
                    statusText = 'Pagado';
                } else if (daysOverdue > 5) {
                    statusClass = 'overdue';
                    statusText = `${daysOverdue} d√≠as de atraso`;
                } else if (daysOverdue > 0) {
                    statusClass = 'grace-period';
                    statusText = `${daysOverdue} d√≠as de gracia`;
                } else {
                    statusClass = 'pending';
                    statusText = 'Pendiente';
                }

                return `
            <div class="property-card ${statusClass}" 
                 data-property-id="${property.id}" 
                 data-due-date="${dueDate.toISOString()}"
                 onclick="openModal('property-detail-modal'); showPropertyDetail('${property.id}', '${dueDate.toISOString()}')">
                <div class="property-header">
                    <div class="property-title">${property.tenantName}</div>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                <div class="property-details" style="padding: 5px;">
                    <p><strong>üìç</strong> ${property.address}</p>
                    <p><strong>üí∞</strong> $${property.rentAmount.toLocaleString()}</p>
                    ${daysOverdue > 0 ? `<p class="overdue-days"><strong>‚ö†Ô∏è</strong> ${daysOverdue} d√≠as de atraso</p>` : ''}
                </div>
            </div>
        `;
            }).join('');

            list.innerHTML = html;

            // Asegurarse de que los clicks en las tarjetas tengan la funci√≥n actualizada
            document.querySelectorAll('.property-card').forEach(card => {
                card.onclick = function () {
                    const propertyId = this.getAttribute('data-property-id');
                    const dueDate = this.getAttribute('data-due-date');
                    openModal('property-detail-modal');
                    showPropertyDetail(propertyId, dueDate);
                };
            });

            openModal('day-modal');
        }

        function showPropertyDetail(propertyId, dateStr) {
            const property = properties.find(p => p.id === propertyId);
            const date = new Date(dateStr);
            const isPaid = isPropertyPaid(property, date);
            const overdueDays = calculateOverdueDays(property, date);
            const payment = getPaymentForProperty(property, date);

            // Determinar si es el primer mes (excluyendo el mismo d√≠a de inicio)
            const contractDate = new Date(property.contractStart);
            const isFirstMonth = date.getMonth() === contractDate.getMonth() &&
                date.getFullYear() === contractDate.getFullYear() &&
                date.getDate() !== contractDate.getDate();

            // Calcular d√≠as proporcionales para primer mes
            const daysToPay = isFirstMonth ?
                Math.ceil((date - contractDate) / (1000 * 60 * 60 * 24)) :
                30;

            // Definir paidMonth aqu√≠
            const paidMonth = new Date(date.getFullYear(), date.getMonth() - 1, 1);

            const modal = document.getElementById('property-detail-modal');
            const content = document.getElementById('property-detail-content');

            let html = `
            <div class="Modal-Title">
        <h2>üè† ${property.tenantName}</h2>
        <span class="close" onclick="closeModal('property-detail-modal')">&times;</span>
        </div>
        <div class="Modal-Body">
        <div class="property-details" style="padding: 5px;">
            <p><strong>üìç Direcci√≥n:</strong> ${property.address}</p>
            <p><strong>üí∞ Renta Mensual:</strong> <span style="color: #4a82cb;font-weight: bold;">$${property.rentAmount.toLocaleString()}</span></p>
            <p><strong>üìÖ Fecha de pago:</strong> ${date.toLocaleDateString('es-ES')}</p>
            ${isFirstMonth ?
                    `<p><strong>üìÖ Periodo a pagar:</strong> ${daysToPay} d√≠as desde ${contractDate.toLocaleDateString('es-ES')}</p>` :
                    `<p><strong>üìÖ Mes que se paga:</strong> ${paidMonth.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}</p>`
                }
            <p><strong>üìÖ D√≠a de Cobro:</strong> <span style="color: #4a82cb;font-weight: bold;">${property.paymentDay}</span></p>
            ${overdueDays > 0 ? `<p class="overdue-days"><strong>‚ö†Ô∏è D√≠as de atraso:</strong> ${overdueDays}</p>` : ''}

         </div>
    `;

            if (isPaid && payment) {
                let paymentDescription = '';
                if (payment.paymentType === 'partial' &&
                    payment.paymentDate.getMonth() === new Date(payment.dueDate).getMonth() &&
                    payment.paymentDate.getFullYear() === new Date(payment.dueDate).getFullYear()) {
                    // Pago parcial del primer mes
                    const daysPaid = payment.notes.match(/\d+/)?.[0] || 'X';
                    paymentDescription = `Pago por ${daysPaid} d√≠as del primer mes`;
                } else {
                    // Pago normal
                    paymentDescription = `Pago completo de ${paidMonth.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}`;
                }

                html += `
            <div class="property-card paid" style="font-size: 14px;color: #b9b9b9;padding: 5px 10px;margin: 0px 14px;">
                <h3>‚≠ê Pago Registrado</h3>
                <p><strong>‚úÖ ${paymentDescription}</strong></p>
                <p><strong>üí≥ M√©todo:</strong> ${payment.paymentMethod}</p>
                <p><strong>üìÖ Fecha de pago:</strong> ${payment.paymentDate.toLocaleDateString('es-ES')}</p>
                <p><strong>‚è∞ D√≠as de atraso:</strong> ${payment.overdueDays || 0}</p>
                ${payment.notes ? `<p><strong>üìù Notas:</strong> ${payment.notes}</p>` : ''}
                <button class="btn" onclick="downloadInvoice('${payment.id}')">üìÑ Descargar Factura</button>
            </div>
        `;
            } else {
                html += `

                    <div style="margin: 20px 0; text-align: center;">
        <button id="whatsapp-reminder-btn" class="whatsapp-btn" onclick="sendWhatsAppReminder('${property.id}')">
            <img src="./img/whatsapp2.svg" style="height: 100%;">Enviar Recordatorio
        </button>
    </div>


            <div class="form-container" style="margin-top: 10px;">
                <h3 style="color: white;margin-bottom: 10px;text-align: center;">üí≥ Registrar Pago üí≤</h3>
                ${isFirstMonth ?
                        `<p style="color: #e67e22; font-weight: bold;">
                    ‚ö†Ô∏è Este es el primer mes del contrato. Debe cobrar solo los d√≠as proporcionales
                </p>` :
                        ''
                    }
                <form id="payment-form">
                    <input type="hidden" id="payment-property-id" value="${property.id}">
                    <input type="hidden" id="payment-due-date" value="${dateStr}">
                    
                    <div class="form-group">
                        <label for="payment-type">Tipo de Pago</label>
                        <select id="payment-type" required onchange="updatePaymentAmount(${property.rentAmount}, ${isFirstMonth})">
                            ${isFirstMonth ?
                        '<option value="partial" selected>Pago Proporcional (primer mes)</option>' :
                        '<option value="complete">Pago Completo</option>'
                    }
                            ${isFirstMonth ? '' : '<option value="partial">Pago Parcial</option>'}
                            ${isFirstMonth ? '' : '<option value="late">Pago con Mora (+ 5%)</option>'}
                            <option value="custom">Pago Personalizado</option>
                        </select>
                    </div>
                    
                    <div id="partial-days-container" ${isFirstMonth ? '' : 'style="display: none;"'}>
                        <div class="form-group">
                            <label for="partial-days">
                                ${isFirstMonth ?
                        'D√≠as a pagar (desde inicio de contrato)' :
                        'D√≠as a pagar'
                    }
                            </label>
                            <input type="number" id="partial-days" min="1" max="30" 
                                   value="${daysToPay}" ${isFirstMonth ? 'readonly' : ''}>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="payment-amount">Monto a Pagar ($)</label>
                        <input type="number" id="payment-amount" step="0.01" 
                               value="${(property.rentAmount / 30 * daysToPay).toFixed(2)}" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="payment-method">M√©todo de Pago</label>
                        <select id="payment-method" required>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Deposito">Dep√≥sito Bancario</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="payment-notes">Notas (opcional)</label>
                        <textarea id="payment-notes" rows="2" placeholder="Ej: Referencia bancaria, etc."></textarea>
                    </div>
                            </div>
                             </div>
                    <div class="Modal-Footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('property-detail-modal')">Cancelar</button>
                        <button type="submit" class="btn btn-success">‚úÖ Registrar Pago</button>
                    </form>
                    </div>
            </div>
        `;
            }

            content.innerHTML = html;

            // Add form listener if payment form exists
            const paymentForm = document.getElementById('payment-form');
            if (paymentForm) {
                // Remover cualquier listener anterior para evitar duplicados
                paymentForm.removeEventListener('submit', processPayment);
                paymentForm.addEventListener('submit', processPayment);
            }

            // Asegurarse de que el modal se abra correctamente
            openModal('property-detail-modal');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('closing');

            // Esperar a que termine la animaci√≥n antes de ocultar
            setTimeout(() => {
                modal.classList.remove('show', 'closing');
                modal.style.display = 'none';
            }, 300); // Debe coincidir con la duraci√≥n de la transici√≥n (0.3s)
        }

        // Y cuando abras un modal, usa:
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'block';
            // Forzar reflow para que la animaci√≥n funcione
            void modal.offsetWidth;
            modal.classList.add('show');
        }



        // Actualiza la funci√≥n updatePaymentAmount:
        function updatePaymentAmount(rentAmount) {
            const paymentType = document.getElementById('payment-type').value;
            const amountInput = document.getElementById('payment-amount');
            const daysContainer = document.getElementById('partial-days-container');

            if (paymentType === 'complete') {
                daysContainer.style.display = 'none';
                amountInput.value = rentAmount;
                amountInput.readOnly = true;
            } else if (paymentType === 'partial') {
                daysContainer.style.display = 'block';
                const daysInput = document.getElementById('partial-days');
                const dailyRate = rentAmount / 30;
                amountInput.value = (dailyRate * daysInput.value).toFixed(2);
                amountInput.readOnly = true;

                daysInput.addEventListener('input', () => {
                    amountInput.value = (dailyRate * daysInput.value).toFixed(2);
                });
            } else if (paymentType === 'late') {
                daysContainer.style.display = 'none';
                const lateFee = rentAmount * 0.05;
                amountInput.value = (rentAmount + lateFee).toFixed(2);
                amountInput.readOnly = true;
            } else if (paymentType === 'custom') {
                daysContainer.style.display = 'none';
                amountInput.value = '';
                amountInput.readOnly = false;
                amountInput.focus();
            }
        }



        // Payment functions
        async function processPayment(e) {
            e.preventDefault();

            const propertyId = document.getElementById('payment-property-id').value;
            const dateStr = document.getElementById('payment-due-date').value;

            if (!propertyId || !dateStr) return;

            const property = properties.find(p => p.id === propertyId);
            const date = new Date(dateStr);
            const paymentMethod = document.getElementById('payment-method').value;
            const notes = document.getElementById('payment-notes').value;
            const overdueDays = calculateOverdueDays(property, date);
            const paymentType = document.getElementById('payment-type').value;
            let amount = parseFloat(document.getElementById('payment-amount').value);

            // En la funci√≥n processPayment, actualiza la parte de paymentNotes:
            let paymentNotes = notes;
            if (paymentType === 'partial') {
                const partialDays = document.getElementById('partial-days').value;
                paymentNotes = `Pago parcial por ${partialDays} d√≠as. ${notes}`;
            } else if (paymentType === 'late') {
                paymentNotes = `Pago con mora del 5%. ${notes}`;
            } else if (paymentType === 'custom') {
                paymentNotes = `Pago personalizado. ${notes}`;
            }

            const payment = {
                propertyId: property.id,
                tenantName: property.tenantName,
                address: property.address,
                amount: amount, // Monto recibido en este pago
                rentAmount: property.rentAmount, // Monto original de la renta
                paymentMethod: paymentMethod,
                paymentDate: new Date(),
                dueDate: date,
                overdueDays: Math.max(0, overdueDays),
                month: date.getMonth(),
                year: date.getFullYear(),
                notes: paymentNotes,
                paymentType: paymentType,
                mesPagado: new Date(date.getFullYear(), date.getMonth() - 1, 1).toLocaleDateString('es-ES', { month: 'long' }).replace(/^\w/, c => c.toUpperCase())
            };

            try {
                const docRef = await db.collection('payments').add(payment);
                payment.id = docRef.id;
                payments.push(payment);

                // Actualizar la vista del modal de d√≠a si est√° abierto
                const dayModal = document.getElementById('day-modal');
                if (dayModal.classList.contains('show')) {
                    const date = new Date(dateStr);
                    const dayProperties = getPropertiesForDay(date);
                    showDayModal(date, dayProperties);
                }

                // Actualizar la vista de lista si est√° abierta
                if (currentView === 'list') {
                    updateListView();
                }

                // Actualizar la vista de atrasos si est√° abierta
                if (currentView === 'overdue') {
                    updateOverdueView();
                }

                // Mostrar modal de √©xito
                document.getElementById('payment-success-id').value = payment.id;
                document.getElementById('payment-success-content').innerHTML = `
            <p><strong>Inquilino:</strong> ${payment.tenantName}</p>
            <p><strong>Tipo de Pago:</strong> ${paymentType === 'complete' ? 'Completo' : paymentType === 'partial' ? 'Parcial' : 'Con Mora'}</p>
            <p><strong>Monto:</strong> $${payment.amount.toLocaleString()}</p>
            <p><strong>M√©todo:</strong> ${payment.paymentMethod}</p>
            <p><strong>Fecha de pago:</strong> ${payment.paymentDate.toLocaleDateString('es-ES')}</p>
        `;

                closeModal('property-detail-modal');
                openModal('payment-success-modal');

                generateCalendar();
                updateListView();
                updateAccountingView();
            } catch (error) {
                console.error('Error processing payment:', error);
                // Demo mode
                payment.id = Date.now().toString();
                payments.push(payment);

                // Show success modal with download option
                document.getElementById('payment-success-id').value = payment.id;
                document.getElementById('payment-success-content').innerHTML = `
            <p><strong>Inquilino:</strong> ${payment.tenantName}</p>
            <p><strong>Tipo de Pago:</strong> ${paymentType === 'complete' ? 'Completo' : paymentType === 'partial' ? 'Parcial' : 'Con Mora'}</p>
            <p><strong>Monto:</strong> $${payment.amount.toLocaleString()}</p>
            <p><strong>M√©todo:</strong> ${payment.paymentMethod}</p>
            <p><strong>Fecha de pago:</strong> ${payment.paymentDate.toLocaleDateString('es-ES')}</p>
        `;

                closeModal('property-detail-modal');
                openModal('payment-success-modal');

                generateCalendar();
                updateListView();
                updateAccountingView();
            }
        }

        // Utility functions
        function isPropertyPaid(property, date) {
            return payments.some(payment =>
                payment.propertyId === property.id &&
                payment.dueDate &&
                payment.dueDate.getMonth() === date.getMonth() &&
                payment.dueDate.getFullYear() === date.getFullYear()
            );
        }

        function getPaymentForProperty(property, date) {
            return payments.find(payment =>
                payment.propertyId === property.id &&
                payment.dueDate &&
                payment.dueDate.getMonth() === date.getMonth() &&
                payment.dueDate.getFullYear() === date.getFullYear()
            );
        }

        function calculateOverdueDays(property, dueDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const due = new Date(dueDate);
            due.setHours(0, 0, 0, 0);

            // Only calculate overdue if today is after due date
            if (today < due) return 0;

            const diffTime = today - due;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(0, diffDays);
        }



        // Invoice generation
        async function generateInvoice(payment) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Intentar obtener la imagen de firma de Firebase
            let signatureImage = null;
            try {
                const configDoc = await db.collection('config').doc('configuracion').get();
                if (configDoc.exists) {
                    signatureImage = configDoc.data().imagenFirma;
                }
            } catch (error) {
                console.error('Error obteniendo imagen de firma:', error);
            }



            // Secci√≥n de firma
            doc.setFontSize(20);
            doc.text('Bieneraigar, S.R.L.', 105, 15, { align: 'center' });


            // Secci√≥n de firma
            doc.setFontSize(12);
            doc.text('RNC: 132716991', 105, 22, { align: 'center' });


            doc.setFontSize(17);
            doc.setTextColor(102, 126, 234);
            doc.text('RECIBO DE PAGO DE RENTA', 105, 35, { align: 'center' });


            // Invoice details
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`ID de Factura: ${payment.id}`, 20, 60);
            doc.text(`Fecha de emisi√≥n: ${payment.paymentDate.toLocaleDateString('es-ES')}`, 20, 70);

            // Tenant information
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold'); // Establecer fuente en negrita
            doc.text('DATOS DEL INQUILINO:', 20, 90);
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Nombre: ${payment.tenantName}`, 20, 100);
            doc.text(`Direcci√≥n: ${payment.address}`, 20, 110);

            // Payment details
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold'); // Establecer fuente en negrita
            doc.text('DETALLES DEL PAGO:', 20, 130);

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            // Nueva l√≠nea para mostrar el mes y a√±o pagado en formato "Julio de 2025"
            doc.text(`Mes pagado: ${payment.mesPagado} de ${payment.year}`, 20, 140);

            doc.text(`Tipo de Pago: ${payment.paymentType === 'complete' ? 'Completo' :
                payment.paymentType === 'partial' ? 'Parcial' :
                    payment.paymentType === 'late' ? 'Con Mora' : 'Personalizado'}`, 20, 150);
            doc.text(`Renta: $${payment.rentAmount.toLocaleString()}`, 20, 160);
            doc.text(`Monto recibido: $${payment.amount.toLocaleString()}`, 20, 170);

            doc.text(`M√©todo de pago: ${payment.paymentMethod}`, 20, 180);
            doc.text(`Fecha de pago: ${payment.paymentDate.toLocaleDateString('es-ES')}`, 20, 190);

            if (payment.overdueDays >= 1) {
                doc.text(`D√≠as de atraso: ${payment.overdueDays}`, 20, 200);
            }
            if (payment.notes) {
                doc.text(`Notas: ${payment.notes}`, 20, 210);
            }

            // Secci√≥n de firma
            doc.setFontSize(12);
            doc.text('Firma del administrativo:', 105, 245, { align: 'center' });

            // L√≠nea para firma
            doc.setDrawColor(0);
            doc.setLineWidth(0.5);
            doc.line(60, 260, 150, 260);

            // Agregar imagen de firma si existe
            if (signatureImage) {
                try {

                    const imgWidth = 70;
                    const imgHeight = 25;
                    const x = (210 - imgWidth) / 2; // Centrar horizontalmente
                    doc.addImage(signatureImage, 'PNG', x, 242, imgWidth, imgHeight);

                } catch (error) {
                    console.error('Error al agregar imagen de firma:', error);
                }
            }




            // Texto final
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Este recibo certifica que el inquilino ha pagado satisfactoriamente el monto', 105, 270, { align: 'center' });
            doc.text('correspondiente al alquiler del mes indicado.', 105, 275, { align: 'center' });

            // Save PDF
            const fileName = `factura_${payment.tenantName.replace(/\s+/g, '_')}_${payment.mesPagado.replace(/\s+/g, '_')}_${payment.year}.pdf`;
            doc.save(fileName);
        }

        // Modificar la funci√≥n downloadInvoice para que sea as√≠ncrona
        async function downloadInvoice(paymentId) {
            const payment = payments.find(p => p.id === paymentId);
            if (payment) {
                await generateInvoice(payment);
            }
        }

        // Accounting functions
        function changeAccountingMonth(direction) {
            currentAccountingDate.setMonth(currentAccountingDate.getMonth() + direction);
            updateAccountingView();
        }

        function updateAccountingView() {
            const month = currentAccountingDate.getMonth();
            const year = currentAccountingDate.getFullYear();

            const monthYear = currentAccountingDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            document.getElementById('accounting-month-title').textContent =
                monthYear.charAt(0).toUpperCase() + monthYear.slice(1);

            // Calculate totals
            const monthPayments = payments.filter(p =>
                p.paymentDate &&
                p.paymentDate.getMonth() === month &&
                p.paymentDate.getFullYear() === year
            );

            const totalCollected = monthPayments.reduce((sum, p) => sum + p.amount, 0);
            const commission = totalCollected * 0.10;

            const monthExpenses = expenses.filter(e =>
                e.date &&
                e.date.getMonth() === month &&
                e.date.getFullYear() === year
            );

            const monthIncomes = incomes.filter(i =>
                i.date &&
                i.date.getMonth() === month &&
                i.date.getFullYear() === year
            );

            const totalExpenses = monthExpenses.reduce((sum, e) => sum + e.amount, 0);
            const totalIncomes = monthIncomes.reduce((sum, i) => sum + i.amount, 0);
            const netProfit = commission + totalIncomes - totalExpenses;

            // Update summary cards
            const summaryContainer = document.getElementById('accounting-summary');
            summaryContainer.innerHTML = `

                <div class="summary-card">
                    <h3>Total Cobrado</h3>
                    <div class="amount">${totalCollected.toLocaleString()}</div>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #2585a9 0%, #00bd4c 100%);">
                    <h3>Comisi√≥n (10%)</h3>
                    <div class="amount">${commission.toLocaleString()}</div>
                </div>


                <div class="summary-card" style="background: #ffffff00;box-shadow: 0 10px 25px rgb(102 126 234 / 0%);padding: 0px;display: inline-flex;gap: 4px;flex-direction: column;">
                     <div id="ingr-gas" style="background: linear-gradient(135deg, #2585a9 0%, #00bd4c 100%);">
                    <h3>Ingresos Extra</h3>
                    <div class="amount">${totalIncomes.toLocaleString()}</div>
</div>
                    <div id="ingr-gas" style="background: linear-gradient(135deg, #7b1111, #c71212, #771414);">
                        <h3>Gastos del Mes</h3>
                       <div class="amount">${totalExpenses.toLocaleString()}</div>
                    </div>
                </div>


                <div class="summary-card" style="background: linear-gradient(135deg, #46e0ef 0%, #00398f 100%);">
                    <h3>Ganancia Neta</h3>
                    <div class="amount">${netProfit.toLocaleString()}</div>
                </div>
            `;

            // Update transactions list
            displayTransactions(monthExpenses, monthIncomes);
        }

        function displayTransactions(expenses, incomes) {
            const container = document.getElementById('expenses-list');

            if (expenses.length === 0 && incomes.length === 0) {
                container.innerHTML = '<div class="no-data">üìä No hay transacciones registradas para este mes</div>';
                return;
            }

            // Combine and sort all transactions by date
            const allTransactions = [
                ...expenses.map(e => ({ ...e, type: 'expense' })),
                ...incomes.map(i => ({ ...i, type: 'income' }))
            ].sort((a, b) => b.date - a.date);

            const html = `
        <h3>üìä Transacciones del Mes</h3>
        ${allTransactions.map(transaction => `
            <div class="expense-item ${transaction.type}">
                <div>
                    <strong>${transaction.description}</strong>
                    <br><small>${transaction.date.toLocaleDateString('es-ES')}</small>
                </div>
                <div>
                    <strong style="color: ${transaction.type === 'income' ? '#16a34a' : '#b91c1c'}">
                        ${transaction.type === 'income' ? '+' : '-'}${transaction.amount.toLocaleString()}
                    </strong>
                    <button class="btn btn-${transaction.type === 'income' ? 'success' : 'danger'}" 
                            onclick="showEditTransactionModal('${transaction.id}', '${transaction.type}')" 
                            style="margin-left: 10px; padding: 5px 10px; font-size: 12px;">
                        ‚úèÔ∏è
                    </button>
                    <button class="btn btn-${transaction.type === 'income' ? 'success' : 'danger'}" 
                            onclick="deleteTransaction('${transaction.id}', '${transaction.type}')" 
                            style="margin-left: 5px; padding: 5px 10px; font-size: 12px;">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        `).join('')}
    `;

            container.innerHTML = html;
        }

        function showIncomeModal() {
            document.getElementById('income-form').reset();
            document.getElementById('income-date').value = new Date().toISOString().split('T')[0];

            // Eliminar cualquier campo oculto de edici√≥n existente
            const hiddenInput = document.querySelector('#income-form input[name="edit-transaction-id"]');
            if (hiddenInput) {
                hiddenInput.remove();
            }

            openModal('income-modal');

        }

        function showExpenseModal() {
            document.getElementById('expense-form').reset();
            document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];

            // Eliminar cualquier campo oculto de edici√≥n existente
            const hiddenInput = document.querySelector('#expense-form input[name="edit-transaction-id"]');
            if (hiddenInput) {
                hiddenInput.remove();
            }

            openModal('expense-modal');

        }

        async function addIncome(e) {
            e.preventDefault();

            const form = e.target;
            const transactionId = form.querySelector('input[name="edit-transaction-id"]')?.value;

            const incomeData = {
                description: document.getElementById('income-description').value,
                amount: parseFloat(document.getElementById('income-amount').value),
                date: new Date(document.getElementById('income-date').value), // Solo date
                // Eliminados: month y year
            };

            try {
                if (transactionId) {
                    // Editar ingreso existente
                    await db.collection('incomes').doc(transactionId).update(incomeData);
                    const index = incomes.findIndex(i => i.id === transactionId);
                    if (index !== -1) {
                        incomes[index] = { ...incomes[index], ...incomeData };
                    }
                    alert('‚úÖ Ingreso actualizado exitosamente');
                } else {
                    // Agregar nuevo ingreso
                    const docRef = await db.collection('incomes').add(incomeData);
                    incomeData.id = docRef.id;
                    incomes.push(incomeData);
                    alert('‚úÖ Ingreso extra agregado exitosamente');
                }

                closeModal('income-modal');
                updateAccountingView();
            } catch (error) {
                console.error('Error processing income:', error);
                // Demo mode
                if (transactionId) {
                    const index = incomes.findIndex(i => i.id === transactionId);
                    if (index !== -1) {
                        incomes[index] = { ...incomes[index], ...incomeData };
                    }
                    alert('‚úÖ Ingreso actualizado (modo demo)');
                } else {
                    incomeData.id = Date.now().toString();
                    incomes.push(incomeData);
                    alert('‚úÖ Ingreso extra agregado (modo demo)');
                }
                closeModal('income-modal');
                updateAccountingView();
            }
        }

        async function addExpense(e) {
            e.preventDefault();

            const form = e.target;
            const transactionId = form.querySelector('input[name="edit-transaction-id"]')?.value;

            const expenseData = {
                description: document.getElementById('expense-description').value,
                amount: parseFloat(document.getElementById('expense-amount').value),
                date: new Date(document.getElementById('expense-date').value), // Solo date
                // Eliminados: month y year
            };

            try {
                if (transactionId) {
                    // Editar gasto existente
                    await db.collection('expenses').doc(transactionId).update(expenseData);
                    const index = expenses.findIndex(e => e.id === transactionId);
                    if (index !== -1) {
                        expenses[index] = { ...expenses[index], ...expenseData };
                    }
                    alert('‚úÖ Gasto actualizado exitosamente');
                } else {
                    // Agregar nuevo gasto
                    const docRef = await db.collection('expenses').add(expenseData);
                    expenseData.id = docRef.id;
                    expenses.push(expenseData);
                    alert('‚úÖ Gasto agregado exitosamente');
                }

                closeModal('expense-modal');
                updateAccountingView();
            } catch (error) {
                console.error('Error processing expense:', error);
                // Demo mode
                if (transactionId) {
                    const index = expenses.findIndex(e => e.id === transactionId);
                    if (index !== -1) {
                        expenses[index] = { ...expenses[index], ...expenseData };
                    }
                    alert('‚úÖ Gasto actualizado (modo demo)');
                } else {
                    expenseData.id = Date.now().toString();
                    expenses.push(expenseData);
                    alert('‚úÖ Gasto agregado (modo demo)');
                }
                closeModal('expense-modal');
                updateAccountingView();
            }
        }


        function showEditTransactionModal(id, type) {
            const transaction = type === 'income'
                ? incomes.find(i => i.id === id)
                : expenses.find(e => e.id === id);

            if (!transaction) return;

            const modalId = type === 'income' ? 'income-modal' : 'expense-modal';
            const formId = type === 'income' ? 'income-form' : 'expense-form';

            // Llenar el formulario con los datos existentes
            document.getElementById(`${type}-description`).value = transaction.description;
            document.getElementById(`${type}-amount`).value = transaction.amount;
            document.getElementById(`${type}-date`).value = transaction.date.toISOString().split('T')[0];

            // Agregar un campo oculto para el ID de la transacci√≥n
            const form = document.getElementById(formId);
            let hiddenInput = form.querySelector('input[name="edit-transaction-id"]');
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'edit-transaction-id';
                form.appendChild(hiddenInput);
            }
            hiddenInput.value = id;

            // Mostrar el modal con animaci√≥n
            openModal(modalId); // <-- Cambiado de style.display = 'block'
        }





        // Mostrar modal para editar pago
        function showEditPaymentModal(paymentId) {
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) return;

            document.getElementById('edit-payment-id').value = payment.id;
            document.getElementById('edit-payment-type').value = payment.paymentType || 'complete';
            document.getElementById('edit-payment-amount').value = payment.amount;
            document.getElementById('edit-payment-method').value = payment.paymentMethod;
            document.getElementById('edit-payment-date').value = payment.paymentDate.toISOString().split('T')[0];
            document.getElementById('edit-payment-notes').value = payment.notes || '';

            openModal('edit-payment-modal'); // <-- Cambiado de style.display = 'block'
        }

        // Actualizar pago
        document.getElementById('edit-payment-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const paymentId = document.getElementById('edit-payment-id').value;
            const paymentIndex = payments.findIndex(p => p.id === paymentId);
            if (paymentIndex === -1) return;

            const updatedPayment = {
                paymentType: document.getElementById('edit-payment-type').value,
                amount: parseFloat(document.getElementById('edit-payment-amount').value),
                paymentMethod: document.getElementById('edit-payment-method').value,
                paymentDate: new Date(document.getElementById('edit-payment-date').value),
                notes: document.getElementById('edit-payment-notes').value,
                // Mantener el mesPagado existente
                mesPagado: payments[paymentIndex].mesPagado,
                year: payments[paymentIndex].year
            };

            try {
                await db.collection('payments').doc(paymentId).update(updatedPayment);
                payments[paymentIndex] = { ...payments[paymentIndex], ...updatedPayment };

                // Cerrar modal con animaci√≥n
                closeModal('edit-payment-modal');

                // Actualizar vistas
                updateListView();
                updateOverdueView();
                generateCalendar();

                // Verificar y actualizar el historial de pagos si est√° visible
                const paymentHistoryModal = document.getElementById('payment-history-modal');
                if (paymentHistoryModal.classList.contains('show')) {
                    showPaymentHistory(payments[paymentIndex].propertyId);
                    // Mantener el modal abierto despu√©s de actualizar
                    openModal('payment-history-modal');
                }

                showAlert('success', 'Factura actualizada exitosamente');
            } catch (error) {
                console.error('Error updating payment:', error);
                // Modo demo
                payments[paymentIndex] = { ...payments[paymentIndex], ...updatedPayment };
                closeModal('edit-payment-modal');
                updateListView();
                updateOverdueView();
                generateCalendar();
                showAlert('info', 'Factura actualizada (modo demo)');
            }
        });

        // Funci√≥n auxiliar para mostrar alertas (opcional)
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Eliminar pago
        async function deletePayment() {
            const paymentId = document.getElementById('edit-payment-id').value;
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta factura?')) {
                return;
            }

            try {
                await db.collection('payments').doc(paymentId).delete();
                const deletedPayment = payments.find(p => p.id === paymentId); // Obtener el pago antes de eliminarlo
                payments = payments.filter(p => p.id !== paymentId);

                // Cerrar el modal de edici√≥n
                closeModal('edit-payment-modal');

                // Si el modal de historial est√° abierto, actualizarlo
                const paymentHistoryModal = document.getElementById('payment-history-modal');
                if (paymentHistoryModal.classList.contains('show') && deletedPayment) {
                    showPaymentHistory(deletedPayment.propertyId);
                }

                // Actualizar otras vistas
                updateListView();
                updateOverdueView();
                generateCalendar();
                updateAccountingView();

                alert('‚úÖ Factura eliminada exitosamente');
            } catch (error) {
                console.error('Error deleting payment:', error);
                // Demo mode
                const deletedPayment = payments.find(p => p.id === paymentId);
                payments = payments.filter(p => p.id !== paymentId);
                closeModal('edit-payment-modal');

                // Actualizar el historial en modo demo
                const paymentHistoryModal = document.getElementById('payment-history-modal');
                if (paymentHistoryModal.classList.contains('show') && deletedPayment) {
                    showPaymentHistory(deletedPayment.propertyId);
                }

                updateListView();
                updateOverdueView();
                generateCalendar();
                updateAccountingView();

                alert('‚úÖ Factura eliminada (modo demo)');
            }
        }



        async function deleteTransaction(id, type) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta transacci√≥n?')) {
                return;
            }

            try {
                if (type === 'income') {
                    await db.collection('incomes').doc(id).delete();
                    incomes = incomes.filter(i => i.id !== id);
                } else {
                    await db.collection('expenses').doc(id).delete();
                    expenses = expenses.filter(e => e.id !== id);
                }
                updateAccountingView();
                alert('‚úÖ Transacci√≥n eliminada');
            } catch (error) {
                console.error('Error deleting transaction:', error);
                // Demo mode
                if (type === 'income') {
                    incomes = incomes.filter(i => i.id !== id);
                } else {
                    expenses = expenses.filter(e => e.id !== id);
                }
                updateAccountingView();
                alert('‚úÖ Transacci√≥n eliminada (modo demo)');
            }
        }

        // Close modals when clicking outside
        /*window.onclick = function (event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        }*/

        // Notification system (mock)
        setInterval(() => {
            const today = new Date();
            const todayProperties = getPropertiesForDay(today);

            todayProperties.forEach(({ property }) => {
                if (!isPropertyPaid(property, today)) {
                    console.log(`üîî Recordatorio: Cobrar renta de ${property.tenantName} - ${property.rentAmount}`);
                }
            });
        }, 60000); // Check every minute










        // Funci√≥n para enviar recordatorio por WhatsApp
        async function sendWhatsAppReminder(propertyId) {
            const property = properties.find(p => p.id === propertyId);
            if (!property || !property.tenantPhone) {
                alert('No se encontr√≥ el n√∫mero de tel√©fono del inquilino');
                return;
            }

            try {
                // Obtener la configuraci√≥n de Firebase
                const configDoc = await db.collection('config').doc('configuracion').get();
                let message = "Saludos, te recuerdo que toca el pago de la renta. Av√≠same cualquier cosa. ¬°Gracias!";

                if (configDoc.exists && configDoc.data().WSmensaje) {
                    message = configDoc.data().WSmensaje;
                }

                // Limpiar el n√∫mero de tel√©fono (eliminar caracteres no num√©ricos)
                const cleanedPhone = property.tenantPhone.replace(/\D/g, '');

                // Codificar el mensaje para URL
                const encodedMessage = encodeURIComponent(message);

                // Crear el enlace de WhatsApp
                const whatsappUrl = `https://wa.me/${cleanedPhone}?text=${encodedMessage}`;

                // Abrir en una nueva pesta√±a
                window.open(whatsappUrl, '_blank');
            } catch (error) {
                console.error('Error al obtener la configuraci√≥n:', error);
                alert('Error al obtener la configuraci√≥n del mensaje');
            }
        }




        // Aseg√∫rate de que la funci√≥n de logout est√© implementada
        document.getElementById('logout-button').addEventListener('click', () => {
            auth.signOut().then(() => {
                // El onAuthStateChanged manejar√° el cambio
            }).catch((error) => {
                console.error('Error al cerrar sesi√≥n:', error);
            });
        });


    // Actualizar el a√±o del copyright autom√°ticamente
    document.addEventListener('DOMContentLoaded', function() {
        const currentYear = new Date().getFullYear();
        const copyrightElements = document.querySelectorAll('.footer2, .fixed-footer');
        
        copyrightElements.forEach(element => {
            if (element.textContent.includes('Developed by Jos√© Polanco')) {
                element.textContent = `¬© ${currentYear} - Developed by Jos√© Polanco`;
            }
        });
    });


// Funci√≥n para ver la imagen del contrato
function viewContractImage() {
    const propertyId = document.getElementById('edit-property-id').value;
    const property = properties.find(p => p.id === propertyId);
    
    if (!property || !property.imageContrato) {
        alert('No hay imagen del contrato para mostrar');
        return;
    }

    const viewer = document.getElementById('contract-image-viewer');
    viewer.src = property.imageContrato;
    viewer.classList.remove('zoomed');
    
    // Configurar zoom al hacer clic
    viewer.onclick = function() {
        this.classList.toggle('zoomed');
    };

    openModal('contract-image-modal');
}

// Funci√≥n para descargar la imagen del contrato
function downloadContractImage() {
    const propertyId = document.getElementById('edit-property-id').value;
    const property = properties.find(p => p.id === propertyId);
    
    if (!property || !property.imageContrato) {
        alert('No hay imagen del contrato para descargar');
        return;
    }

    const link = document.createElement('a');
    link.href = property.imageContrato;
    link.download = `contrato_${property.address.replace(/\s+/g, '_')}.jpg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Funci√≥n para eliminar la imagen del contrato
async function deleteContractImage() {
    if (!confirm('¬øEst√°s seguro de que quieres eliminar la imagen del contrato?')) {
        return;
    }

    const propertyId = document.getElementById('edit-property-id').value;
    const propertyIndex = properties.findIndex(p => p.id === propertyId);
    
    if (propertyIndex === -1) {
        alert('No se encontr√≥ la propiedad');
        return;
    }

    try {
        // Mostrar loader
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        // Eliminar de Firebase
        await db.collection('properties').doc(propertyId).update({
            imageContrato: firebase.firestore.FieldValue.delete()
        });
        
        // Actualizar estado local
        properties[propertyIndex].imageContrato = '';
        
        // Actualizar visualizaci√≥n
        updateImageDisplay();
        
        // Ocultar loader
        document.getElementById('loadingOverlay').style.display = 'none';
        
        alert('‚úÖ Imagen eliminada correctamente');
    } catch (error) {
        console.error('Error eliminando imagen:', error);
        document.getElementById('loadingOverlay').style.display = 'none';
        
        // Intento alternativo si falla el m√©todo delete
        try {
            await db.collection('properties').doc(propertyId).update({
                imageContrato: null
            });
            
            properties[propertyIndex].imageContrato = '';
            updateImageDisplay();
            alert('‚úÖ Imagen eliminada (segundo intento)');
        } catch (secondError) {
            console.error('Error en segundo intento:', secondError);
            alert('‚ùå Error al eliminar la imagen. Intente nuevamente.');
        }
    }
}

// Funci√≥n auxiliar para actualizar la visualizaci√≥n de la imagen
function updateImageDisplay() {
    const propertyId = document.getElementById('edit-property-id').value;
    const property = properties.find(p => p.id === propertyId);
    const imageContainer = document.getElementById('edit-current-image-container');
    const imageWrapper = document.getElementById('edit-current-image-wrapper');
    const imageElement = document.getElementById('edit-current-image');
    const imageActions = document.getElementById('edit-image-actions');
    const imageInput = document.getElementById('edit-contract-image');

    // Resetear el input de archivo
    if (imageInput) {
        imageInput.value = '';
    }

    if (property && property.imageContrato) {
        // Mostrar imagen existente
        imageElement.src = property.imageContrato;
        imageWrapper.style.display = 'block';
        imageActions.style.display = 'flex';
        imageContainer.style.display = 'block';
    } else {
        // No hay imagen
        imageWrapper.innerHTML = '<p style="color: #777; font-style: italic;">Sin imagen del contrato</p>';
        imageActions.style.display = 'none';
        imageContainer.style.display = 'block';
    }
}
    </script>
</body>

</html>

<!-- 1 -->